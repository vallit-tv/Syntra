<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vallit Chatbot Connection Tester</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }

        .log {
            margin-bottom: 5px;
            border-bottom: 1px solid #333;
            padding: 5px;
        }

        .error {
            color: #ff5555;
        }

        .success {
            color: #55ff55;
        }

        .info {
            color: #5555ff;
        }

        #controls {
            margin-bottom: 20px;
            padding: 10px;
            background: #2a2a2a;
            border: 1px solid #444;
        }

        input {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px;
            width: 300px;
        }

        button {
            background: #008800;
            color: white;
            border: none;
            padding: 5px 15px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Vallit API Connection Tester</h1>
    <div id="controls">
        <label>API URL: <input type="text" id="apiUrl" value="https://vallit.net"></label>
        <button onclick="runTest()">Run Test</button>
    </div>
    <div id="logs"></div>

    <script>
        const log = (msg, type = 'normal') => {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('logs').prepend(div);
        };

        async function runTest() {
            const baseUrl = document.getElementById('apiUrl').value.replace(/\/$/, '');
            const targetUrl = `${baseUrl}/api/chat/config?widget_id=test`;
            const postUrl = `${baseUrl}/api/chat/message`;

            log(`Starting test against: ${baseUrl}`, 'info');

            // 1. Test Config (GET)
            try {
                log(`Attempting GET ${targetUrl}...`);
                const res = await fetch(targetUrl);
                log(`GET Status: ${res.status}`);

                if (!res.ok) {
                    throw new Error(`GET failed with status ${res.status}`);
                }

                const data = await res.json();
                log(`GET Success! Response: ${JSON.stringify(data).substring(0, 100)}...`, 'success');

            } catch (e) {
                log(`GET Error: ${e.message}`, 'error');
                if (e.message.includes('Failed to fetch')) {
                    log(`POTENTIAL CAUSE: CORS Blocked or SSL Error. Check Console for details.`, 'error');
                }
            }

            // 2. Test Message (POST)
            try {
                log(`Attempting POST ${postUrl}...`);
                const res = await fetch(postUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Debug Connection Test',
                        session_id: 'debug_' + Date.now(),
                        widget_id: 'default'
                    })
                });

                log(`POST Status: ${res.status}`);

                if (!res.ok) {
                    // Try to read error text
                    const txt = await res.text();
                    throw new Error(`POST failed: ${res.status} - ${txt}`);
                }

                const data = await res.json();
                log(`POST Success! Engine says: ${data.response}`, 'success');

            } catch (e) {
                log(`POST Error: ${e.message}`, 'error');
            }
        }
    </script>
</body>

</html>