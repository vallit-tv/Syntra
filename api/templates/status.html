{% extends "base.html" %}

{% block title %}System Status - Syntra{% endblock %}

{% block content %}
<div class="container py-20">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold">System Status</h1>
            <div id="global-status" class="px-3 py-1 bg-gray-200 rounded-full text-sm font-medium">Checking...</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <!-- Database -->
            <div class="p-6 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-xl">
                <h3 class="text-sm text-[var(--text-secondary)] mb-2">Database</h3>
                <div id="status-db" class="text-xl font-semibold flex items-center gap-2">
                    <span class="animate-pulse w-2 h-2 rounded-full bg-gray-400"></span>
                    Testing...
                </div>
            </div>

            <!-- OpenAI API -->
            <div class="p-6 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-xl">
                <h3 class="text-sm text-[var(--text-secondary)] mb-2">AI Engine (OpenAI)</h3>
                <div id="status-ai" class="text-xl font-semibold flex items-center gap-2">
                    <span class="animate-pulse w-2 h-2 rounded-full bg-gray-400"></span>
                    Testing...
                </div>
            </div>

            <!-- Environment -->
            <div class="p-6 bg-[var(--bg-elevated)] border border-[var(--border-color)] rounded-xl">
                <h3 class="text-sm text-[var(--text-secondary)] mb-2">Environment</h3>
                <div id="status-env" class="text-xl font-semibold flex items-center gap-2">
                    <span class="animate-pulse w-2 h-2 rounded-full bg-gray-400"></span>
                    Checking...
                </div>
            </div>
        </div>

        <!-- Recent Logs (Secured) -->
        <div class="border-t border-[var(--border-color)] pt-8">
            <h2 class="text-xl font-bold mb-4">Recent Server Logs</h2>
            <p class="text-[var(--text-secondary)] text-sm mb-4">Displaying last 50 server events. Requires Admin
                access.</p>

            <div class="bg-black rounded-xl border border-[var(--border-color)] overflow-hidden font-mono text-xs">
                <div id="logs-container" class="p-4 h-96 overflow-y-auto space-y-1 text-gray-300">
                    <div class="text-gray-500 italic">Authenticating and fetching logs...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function checkHealth() {
        try {
            const res = await fetch('/api/debug/diagnose');
            const data = await res.json();

            // Database
            const dbEl = document.getElementById('status-db');
            if (data.database === 'CONNECTED') {
                dbEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Operational';
                dbEl.classList.add('text-green-500');
            } else {
                dbEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Error';
                dbEl.classList.add('text-red-500');
            }

            // OpenAI
            const aiEl = document.getElementById('status-ai');
            if (data.openai === 'CONNECTED') {
                aiEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Operational';
                aiEl.classList.add('text-green-500');
            } else {
                aiEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> ${data.openai}`;
                aiEl.classList.add('text-red-500');
            }

            // Environment
            const envEl = document.getElementById('status-env');
            const missing = Object.entries(data.environment).filter(([k, v]) => v === 'MISSING').map(([k, v]) => k);
            if (missing.length === 0) {
                envEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Healthy';
                envEl.classList.add('text-green-500');
            } else {
                envEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-yellow-500"></span> Missing Vars`;
                envEl.classList.add('text-yellow-500');
            }

            // Global
            const globalEl = document.getElementById('global-status');
            if (data.database === 'CONNECTED' && data.openai === 'CONNECTED' && missing.length === 0) {
                globalEl.textContent = 'All Systems Operational';
                globalEl.className = 'px-3 py-1 bg-green-500/10 text-green-500 rounded-full text-sm font-medium border border-green-500/20';
            } else {
                globalEl.textContent = 'System Issues Detected';
                globalEl.className = 'px-3 py-1 bg-red-500/10 text-red-500 rounded-full text-sm font-medium border border-red-500/20';
            }

        } catch (e) {
            console.error(e);
        }
    }

    async function fetchLogs() {
        try {
            // Try to fetch logs - browser session cookies should handle auth if logged in as admin
            const res = await fetch('/api/debug/logs');

            const container = document.getElementById('logs-container');

            if (res.status === 401) {
                container.innerHTML = '<div class="text-yellow-500">Access Denied. Please log in as an Admin to view logs.</div>';
                return;
            }

            const data = await res.json();

            if (data.logs && data.logs.length > 0) {
                container.innerHTML = data.logs.map(log => {
                    const color = log.level === 'ERROR' || log.level === 'CRITICAL' ? 'text-red-400' :
                        log.level === 'WARN' ? 'text-yellow-400' : 'text-gray-400';
                    return `<div class="border-b border-gray-800 pb-1 mb-1 last:border-0">
                        <span class="text-gray-600">[${log.timestamp.split('T')[1].split('.')[0]}]</span>
                        <span class="${color} font-bold">${log.level}</span>: 
                        <span class="text-gray-300">${log.message}</span>
                        ${log.details && log.details !== 'None' ? `<div class="ml-14 text-gray-500 mt-0.5 whitespace-pre-wrap">${log.details.substring(0, 300)}${log.details.length > 300 ? '...' : ''}</div>` : ''}
                    </div>`;
                }).reverse().join('');
            } else {
                container.innerHTML = '<div class="text-gray-500">No logs captured yet.</div>';
            }

        } catch (e) {
            document.getElementById('logs-container').textContent = 'Failed to load logs.';
        }
    }

    // Init
    checkHealth();
    fetchLogs();
</script>
{% endblock %}