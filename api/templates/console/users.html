{% extends "layout_console_v3.html" %}

{% block page_title %}Users{% endblock %}

{% block header_actions %}
<button class="btn btn-primary btn-sm" style="margin-left: var(--space-4);"
    onclick="Vallit.Modal.open('create-user-modal')">
    <i data-lucide="user-plus" width="14" height="14"></i>
    New User
</button>
{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">

    <p class="text-muted">Manage team members and their access levels.</p>

    <!-- STATS -->
    <div class="stat-grid" style="grid-template-columns: repeat(4, 1fr);">
        <div class="stat-card">
            <div class="stat-label">Total Users</div>
            <div class="stat-value">{{ users|length }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Admins</div>
            <div class="stat-value">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Active</div>
            <div class="stat-value">{{ users|selectattr('is_password_set')|list|length }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Pending</div>
            <div class="stat-value">{{ users|rejectattr('is_password_set')|list|length }}</div>
        </div>
    </div>

    <!-- USERS TABLE -->
    <div class="card">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Company</th>
                        <th>Status</th>
                        <th style="width: 140px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if users %}
                    {% for u in users %}
                    <tr>
                        <td>
                            <div class="flex items-center gap-3">
                                <div class="user-avatar" style="width: 32px; height: 32px; font-size: 12px;">
                                    {{ u.name[0]|upper if u.name else 'U' }}
                                </div>
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">{{ u.name }}</div>
                                    <div class="text-xs text-muted">{{ u.email if u.email else '—' }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge {% if u.role == 'admin' %}badge-info{% else %}badge-default{% endif %}">
                                {{ (u.role or 'user')|upper }}
                            </span>
                        </td>
                        <td>
                            <span class="text-muted">{{ u.company_name if u.company_name else '—' }}</span>
                        </td>
                        <td>
                            <span
                                class="badge {% if u.is_password_set %}badge-success{% else %}badge-warning{% endif %}">
                                {{ 'Active' if u.is_password_set else 'Pending' }}
                            </span>
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-ghost btn-icon btn-sm"
                                    onclick="editUser('{{ u.id }}', '{{ u.name }}', '{{ u.role or 'user' }}', '{{ u.company_id or '' }}')"
                                    title="Edit User">
                                    <i data-lucide="edit-3" width="14" height="14"></i>
                                </button>
                                <button class="btn btn-ghost btn-icon btn-sm"
                                    onclick="confirmDeleteUser('{{ u.id }}', '{{ u.name }}')" title="Delete User"
                                    style="color: var(--error);">
                                    <i data-lucide="trash-2" width="14" height="14"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i data-lucide="users" width="24" height="24"></i>
                                </div>
                                <div class="empty-state-title">No users yet</div>
                                <div class="empty-state-description">
                                    Create users to give them access to the dashboard.
                                </div>
                                <button class="btn btn-primary" onclick="Vallit.Modal.open('create-user-modal')">
                                    <i data-lucide="user-plus" width="14" height="14"></i>
                                    Create User
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}

{% block modals %}
<!-- CREATE USER MODAL -->
<div id="create-user-modal" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Create User</h3>
            <button class="modal-close" onclick="Vallit.Modal.close()">
                <i data-lucide="x" width="18" height="18"></i>
            </button>
        </div>
        <form id="createUserForm">
            <div class="modal-body">
                <div class="flex flex-col gap-4">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" name="name" id="createUserName" class="form-input w-full"
                            placeholder="e.g., John Doe" required>
                        <span class="form-hint">User will set their password on first login.</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select name="role" id="createUserRole" class="form-select w-full">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Company (Optional)</label>
                        <select name="company_id" id="createUserCompany" class="form-select w-full">
                            <option value="">— No company —</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="Vallit.Modal.close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT USER MODAL -->
<div id="edit-user-modal" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Edit User</h3>
            <button class="modal-close" onclick="Vallit.Modal.close()">
                <i data-lucide="x" width="18" height="18"></i>
            </button>
        </div>
        <form id="editUserForm">
            <input type="hidden" name="user_id" id="editUserId">
            <div class="modal-body">
                <div class="flex flex-col gap-4">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" name="name" id="editUserName" class="form-input w-full" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select name="role" id="editUserRole" class="form-select w-full">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Company</label>
                        <select name="company_id" id="editUserCompany" class="form-select w-full">
                            <option value="">— No company —</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="Vallit.Modal.close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Create user
    document.getElementById('createUserForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const data = {
            name: document.getElementById('createUserName').value,
            role: document.getElementById('createUserRole').value,
            company_id: document.getElementById('createUserCompany').value || null
        };

        fetch('/api/admin/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(d => {
                if (d.error) {
                    Vallit.Toast.error(d.error);
                } else {
                    Vallit.Modal.close();
                    Vallit.Toast.success('User created. They can now login and set their password.');
                    setTimeout(() => location.reload(), 500);
                }
            })
            .catch(() => Vallit.Toast.error('Failed to create user'));
    });

    // Edit user
    function editUser(id, name, role, companyId) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editUserName').value = name;
        document.getElementById('editUserRole').value = role;
        document.getElementById('editUserCompany').value = companyId;
        Vallit.Modal.open('edit-user-modal');
    }

    document.getElementById('editUserForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const id = document.getElementById('editUserId').value;
        const data = {
            name: document.getElementById('editUserName').value,
            role: document.getElementById('editUserRole').value,
            company_id: document.getElementById('editUserCompany').value || null
        };

        fetch('/api/admin/users/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(d => {
                if (d.error) {
                    Vallit.Toast.error(d.error);
                } else {
                    Vallit.Modal.close();
                    Vallit.Toast.success('User updated');
                    setTimeout(() => location.reload(), 500);
                }
            })
            .catch(() => Vallit.Toast.error('Failed to update user'));
    });

    // Delete user
    async function confirmDeleteUser(id, name) {
        const confirmed = await Vallit.Modal.confirm({
            title: 'Delete User',
            message: `Are you sure you want to delete "${name}"? This action cannot be undone.`,
            confirmText: 'Delete',
            cancelText: 'Cancel',
            type: 'danger'
        });

        if (confirmed) {
            fetch('/api/admin/users/' + id, { method: 'DELETE' })
                .then(r => r.json())
                .then(d => {
                    if (d.error) {
                        Vallit.Toast.error(d.error);
                    } else {
                        Vallit.Toast.success('User deleted');
                        setTimeout(() => location.reload(), 500);
                    }
                })
                .catch(() => Vallit.Toast.error('Failed to delete user'));
        }
    }
</script>
{% endblock %}