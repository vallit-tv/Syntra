{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<span>Workflows</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <div style="display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 class="page-title">Workflows</h1>
            <p class="page-description">Manage your automation workflows and connect with n8n.</p>
        </div>
        <div style="display: flex; gap: 0.75rem; align-items: center;">
            <button onclick="syncN8nWorkflows()" class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="refresh-cw" width="16" height="16"></i>
                Sync with n8n
            </button>
            <a href="{{ url_for('dashboard_workflow_create') }}" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="plus" width="16" height="16"></i>
                Create Workflow
            </a>
        </div>
    </div>
</div>

<!-- n8n Connection Status -->
<div class="dashboard-card" style="background: var(--color-primary-light); border-color: var(--color-primary); margin-bottom: 1.5rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <i data-lucide="workflow" width="24" height="24" style="color: var(--color-primary);"></i>
        <div style="flex: 1;">
            <h3 style="font-size: var(--text-base); font-weight: var(--font-semibold); margin-bottom: 0.25rem; color: var(--color-text);">n8n Integration Status</h3>
            <p style="font-size: var(--text-sm); color: var(--color-text-light); margin: 0;">
                {% if n8n_connected %}
                Connected to {{ n8n_instance_url|default('n8n instance') }}
                {% else %}
                Not connected. <a href="{{ url_for('dashboard_integrations') }}" style="color: var(--color-primary); text-decoration: underline;">Connect n8n</a> to sync workflows.
                {% endif %}
            </p>
        </div>
        <span class="status-badge {{ 'active' if n8n_connected else 'inactive' }}">
            <span class="status-badge-dot"></span>
            {{ 'Connected' if n8n_connected else 'Disconnected' }}
        </span>
    </div>
</div>

<!-- Filters and Actions -->
<div class="filters-bar">
    <div style="position: relative; flex: 1; min-width: 240px;">
        <i data-lucide="search" width="16" height="16" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--color-text-lighter);"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search workflows..." style="padding-left: 2.5rem;">
    </div>
    <select id="statusFilter" class="filter-select">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="error">Error</option>
        <option value="running">Running</option>
    </select>
</div>

<!-- Workflows List -->
<div class="dashboard-card">
    {% if workflows %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Last Run</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for workflow in workflows %}
                <tr>
                    <td>
                        <a href="{{ url_for('dashboard_workflow_detail', workflow_id=workflow.id) }}" style="font-weight: 600; color: var(--color-primary); text-decoration: none;">
                            {{ workflow.name }}
                        </a>
                    </td>
                    <td>{{ workflow.description|default('No description') }}</td>
                    <td>
                        <span class="status-badge {{ workflow.status|lower }}">
                            <span class="status-badge-dot"></span>
                            {{ workflow.status }}
                        </span>
                    </td>
                    <td>{{ workflow.last_run|default('Never') }}</td>
                    <td>
                        <div class="table-actions">
                            <a href="{{ url_for('dashboard_workflow_detail', workflow_id=workflow.id) }}" class="btn btn-secondary btn-sm" style="display: inline-flex; align-items: center; gap: 0.375rem;">
                                <i data-lucide="edit-3" width="14" height="14"></i>
                                Edit
                            </a>
                            <button onclick="runWorkflow('{{ workflow.id }}')" class="btn btn-primary btn-sm" style="display: inline-flex; align-items: center; gap: 0.375rem;">
                                <i data-lucide="play" width="14" height="14"></i>
                                Run
                            </button>
                            <button onclick="deleteWorkflow('{{ workflow.id }}')" class="btn btn-danger btn-sm" style="display: inline-flex; align-items: center; gap: 0.375rem;">
                                <i data-lucide="trash-2" width="14" height="14"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i data-lucide="workflow" width="32" height="32"></i>
        </div>
        <h3 class="empty-state-title">No workflows yet</h3>
        <p class="empty-state-description">Create your first workflow to start automating your processes.</p>
        <a href="{{ url_for('dashboard_workflow_create') }}" class="btn btn-primary">Create Workflow</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
function syncN8nWorkflows() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    
    // Add spinning animation
    icon.style.animation = 'spin 1s linear infinite';
    btn.disabled = true;
    
    fetch('/api/workflows/sync', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error syncing workflows: ' + data.error);
            } else {
                alert('Workflows synced successfully!');
                location.reload();
            }
        })
        .catch(err => {
            alert('Error: ' + err);
        })
        .finally(() => {
            icon.style.animation = '';
            btn.disabled = false;
        });
}

function runWorkflow(workflowId) {
    if (confirm('Run this workflow now?')) {
        fetch(`/api/workflows/${workflowId}/run`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Workflow started successfully');
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
    }
}

function deleteWorkflow(workflowId) {
    if (confirm('Are you sure you want to delete this workflow? This action cannot be undone.')) {
        fetch(`/api/workflows/${workflowId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
    }
}

// Simple search and filter
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const tableRows = document.querySelectorAll('.table tbody tr');
    
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value.toLowerCase();
        
        tableRows.forEach(row => {
            const name = row.cells[0].textContent.toLowerCase();
            const status = row.cells[2].textContent.toLowerCase();
            
            const matchesSearch = name.includes(searchTerm);
            const matchesStatus = !statusValue || status.includes(statusValue);
            
            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }
    
    if (searchInput) searchInput.addEventListener('input', filterTable);
    if (statusFilter) statusFilter.addEventListener('change', filterTable);
    
    // Reinitialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

