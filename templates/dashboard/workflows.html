{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<span>Workflows</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">Workflows</h1>
    <p class="page-description">Activate and manage automation workflows.</p>
</div>

<!-- Filters -->
<div class="filters-bar">
    <div style="position: relative; flex: 1; max-width: 280px;">
        <i data-lucide="search" width="14" height="14"
            style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--db-text-tertiary);"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search workflows..."
            style="padding-left: 32px;">
    </div>
    <select id="statusFilter" class="filter-select">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
    </select>
</div>

<!-- Workflows List -->
<div class="dashboard-card">
    {% if workflows %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for workflow in workflows %}
                <tr>
                    <td>
                        <a href="{{ url_for('dashboard_workflow_detail', workflow_id=workflow.id) }}"
                            style="font-weight: 500; color: var(--db-text-primary); text-decoration: none;">
                            {{ workflow.name }}
                        </a>
                    </td>
                    <td style="color: var(--db-text-secondary);">{{ workflow.description|default('â€”')|truncate(50) }}
                    </td>
                    <td>
                        {% if workflow.is_activated %}
                        <span class="status-badge active">Active</span>
                        {% else %}
                        <span class="status-badge inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="table-actions">
                            {% if workflow.is_activated %}
                            <a href="{{ url_for('dashboard_workflow_detail', workflow_id=workflow.id) }}"
                                class="btn btn-secondary btn-sm">Configure</a>
                            <button onclick="deactivateWorkflow('{{ workflow.id }}')"
                                class="btn btn-danger btn-sm">Deactivate</button>
                            {% else %}
                            <button onclick="activateWorkflow('{{ workflow.id }}')"
                                class="btn btn-primary btn-sm">Activate</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i data-lucide="workflow" width="24" height="24"></i>
        </div>
        <h3 class="empty-state-title">No workflows available</h3>
        <p class="empty-state-description">Contact your administrator to make workflows available.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
    function activateWorkflow(workflowId) {
        fetch(`/api/workflows/${workflowId}/activate`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    window.location.href = `/dashboard/workflows/${workflowId}`;
                }
            })
            .catch(err => alert('Error: ' + err));
    }

    function deactivateWorkflow(workflowId) {
        if (confirm('Deactivate this workflow?')) {
            fetch(`/api/workflows/${workflowId}/deactivate`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        location.reload();
                    }
                })
                .catch(err => alert('Error: ' + err));
        }
    }

    // Search and filter
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const tableRows = document.querySelectorAll('.table tbody tr');

        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value.toLowerCase();

            tableRows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const status = row.cells[2].textContent.toLowerCase();

                const matchesSearch = name.includes(searchTerm);
                const matchesStatus = !statusValue || status.includes(statusValue);

                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });
        }

        if (searchInput) searchInput.addEventListener('input', filterTable);
        if (statusFilter) statusFilter.addEventListener('change', filterTable);

        if (typeof lucide !== 'undefined') lucide.createIcons();
    });
</script>
{% endblock %}