{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<a href="{{ url_for('dashboard_settings') }}">Settings</a>
<span class="breadcrumbs-separator">/</span>
<span>Organization</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">Organization Settings</h1>
    <p class="page-description">Manage your organization's profile and preferences.</p>
</div>

<!-- Organization Profile -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="building" width="20" height="20"></i>
            Organization Profile
        </h2>
    </div>
    <form id="orgProfileForm">
        <div style="display: grid; gap: 1.5rem;">
            <!-- Organization Logo -->
            <div class="form-group">
                <label class="form-label">Organization Logo</label>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 80px; height: 80px; border-radius: var(--radius-lg); border: 2px solid var(--color-border); display: flex; align-items: center; justify-content: center; background: var(--color-bg-muted); overflow: hidden;">
                        {% if organization.logo_url %}
                        <img src="{{ organization.logo_url }}" alt="Organization logo" style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        <i data-lucide="building" width="32" height="32" style="color: var(--color-text-lighter);"></i>
                        {% endif %}
                    </div>
                    <div>
                        <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                        <button type="button" onclick="document.getElementById('logoUpload').click()" class="btn btn-secondary btn-sm" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <i data-lucide="upload" width="14" height="14"></i>
                            Upload Logo
                        </button>
                        <p style="font-size: var(--text-xs); color: var(--color-text-light); margin-top: 0.5rem;">PNG, JPG up to 2MB</p>
                    </div>
                </div>
            </div>

            <!-- Organization Name -->
            <div class="form-group">
                <label for="orgName" class="form-label">Organization Name</label>
                <input type="text" id="orgName" name="name" value="{{ organization.name if organization else '' }}" required class="form-input" placeholder="Acme Inc.">
            </div>

            <!-- Organization Slug -->
            <div class="form-group">
                <label for="orgSlug" class="form-label">Organization Slug</label>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--color-text-light); font-size: var(--text-sm);">syntra.app/</span>
                    <input type="text" id="orgSlug" name="slug" value="{{ organization.slug if organization else '' }}" required class="form-input" placeholder="acme" pattern="[a-z0-9-]+" style="flex: 1;">
                </div>
                <p style="font-size: var(--text-xs); color: var(--color-text-light); margin-top: 0.5rem;">Lowercase letters, numbers, and hyphens only</p>
            </div>

            <!-- Description -->
            <div class="form-group">
                <label for="orgDescription" class="form-label">Description (Optional)</label>
                <textarea id="orgDescription" name="description" class="form-input" rows="3" placeholder="A brief description of your organization...">{{ organization.description if organization else '' }}</textarea>
            </div>

            <div style="display: flex; gap: 0.75rem;">
                <button type="submit" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="save" width="16" height="16"></i>
                    Save Changes
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Organization Preferences -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="sliders" width="20" height="20"></i>
            Preferences
        </h2>
    </div>
    <form id="orgPreferencesForm">
        <div style="display: grid; gap: 1.5rem;">
            <!-- Timezone -->
            <div class="form-group">
                <label for="timezone" class="form-label">Timezone</label>
                <select id="timezone" name="timezone" class="form-input">
                    <option value="UTC">UTC (Coordinated Universal Time)</option>
                    <option value="America/New_York">Eastern Time (ET)</option>
                    <option value="America/Chicago">Central Time (CT)</option>
                    <option value="America/Denver">Mountain Time (MT)</option>
                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                    <option value="Europe/London">London (GMT)</option>
                    <option value="Europe/Paris">Paris (CET)</option>
                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                </select>
            </div>

            <!-- Date Format -->
            <div class="form-group">
                <label for="dateFormat" class="form-label">Date Format</label>
                <select id="dateFormat" name="date_format" class="form-input">
                    <option value="MM/DD/YYYY">MM/DD/YYYY (US)</option>
                    <option value="DD/MM/YYYY">DD/MM/YYYY (EU)</option>
                    <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
                </select>
            </div>

            <!-- Notification Preferences -->
            <div class="form-group">
                <label class="form-label">Email Notifications</label>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="notify_workflow_failures" checked style="width: 16px; height: 16px;">
                        <span style="font-size: var(--text-sm);">Workflow failures</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="notify_team_changes" checked style="width: 16px; height: 16px;">
                        <span style="font-size: var(--text-sm);">Team member changes</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="notify_billing" checked style="width: 16px; height: 16px;">
                        <span style="font-size: var(--text-sm);">Billing and subscription updates</span>
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem;">
                <button type="submit" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="save" width="16" height="16"></i>
                    Save Preferences
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Security Settings -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="shield" width="20" height="20"></i>
            Security
        </h2>
    </div>
    <div style="display: grid; gap: 1.5rem;">
        <!-- Two-Factor Authentication -->
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--color-bg-subtle); border-radius: var(--radius-lg);">
            <div>
                <h3 style="font-weight: var(--font-semibold); margin-bottom: 0.25rem;">Two-Factor Authentication</h3>
                <p style="font-size: var(--text-sm); color: var(--color-text-light);">Require 2FA for all team members</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="require2FA" onchange="toggle2FA(this.checked)">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Session Timeout -->
        <div class="form-group">
            <label for="sessionTimeout" class="form-label">Session Timeout</label>
            <select id="sessionTimeout" name="session_timeout" class="form-input">
                <option value="30">30 minutes</option>
                <option value="60" selected>1 hour</option>
                <option value="480">8 hours</option>
                <option value="1440">24 hours</option>
            </select>
        </div>
    </div>
</div>

<!-- Danger Zone -->
<div class="dashboard-card" style="border-color: var(--color-danger); background: var(--color-danger-light);">
    <div class="card-header">
        <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem; color: var(--color-danger);">
            <i data-lucide="alert-triangle" width="20" height="20"></i>
            Danger Zone
        </h2>
    </div>
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
            <h3 style="font-weight: var(--font-semibold); margin-bottom: 0.25rem; color: var(--color-text);">Delete Organization</h3>
            <p style="font-size: var(--text-sm); color: var(--color-text-light);">Permanently delete this organization and all associated data. This action cannot be undone.</p>
        </div>
        <button onclick="deleteOrganization()" class="btn btn-danger" style="display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="trash-2" width="16" height="16"></i>
            Delete Organization
        </button>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (file) {
        if (file.size > 2 * 1024 * 1024) {
            alert('File size must be less than 2MB');
            return;
        }
        
        const formData = new FormData();
        formData.append('logo', file);
        
        fetch('/api/organization/logo', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                location.reload();
            }
        })
        .catch(err => alert('Error: ' + err));
    }
}

function toggle2FA(enabled) {
    fetch('/api/organization/security/2fa', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ require_2fa: enabled })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            location.reload();
        } else {
            alert('2FA requirement updated successfully');
        }
    })
    .catch(err => {
        alert('Error: ' + err);
        location.reload();
    });
}

function deleteOrganization() {
    const confirmation = prompt('Type DELETE to confirm organization deletion:');
    if (confirmation === 'DELETE') {
        fetch('/api/organization', { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    window.location.href = '/';
                }
            })
            .catch(err => alert('Error: ' + err));
    } else if (confirmation !== null) {
        alert('Deletion cancelled - confirmation text did not match');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Organization Profile Form
    const orgProfileForm = document.getElementById('orgProfileForm');
    if (orgProfileForm) {
        orgProfileForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            fetch('/api/organization', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Organization profile updated successfully!');
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
        });
    }
    
    // Organization Preferences Form
    const orgPreferencesForm = document.getElementById('orgPreferencesForm');
    if (orgPreferencesForm) {
        orgPreferencesForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Handle checkboxes
            data.notify_workflow_failures = this.querySelector('[name="notify_workflow_failures"]').checked;
            data.notify_team_changes = this.querySelector('[name="notify_team_changes"]').checked;
            data.notify_billing = this.querySelector('[name="notify_billing"]').checked;
            
            fetch('/api/organization/preferences', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Preferences updated successfully!');
                }
            })
            .catch(err => alert('Error: ' + err));
        });
    }
    
    // Initialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>

<style>
/* Toggle Switch */
.switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 28px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--color-border-dark);
    transition: 0.2s;
    border-radius: 28px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.2s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--color-primary);
}

input:checked + .slider:before {
    transform: translateX(20px);
}
</style>
{% endblock %}

