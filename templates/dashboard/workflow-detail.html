{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<a href="{{ url_for('dashboard_workflows') }}">Workflows</a>
<span class="breadcrumbs-separator">/</span>
<span>{{ workflow.name|default('New Workflow') }}</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">{{ workflow.name|default('New Workflow') }}</h1>
    <p class="page-description">{{ workflow.description|default('Configure your workflow settings and connect with n8n') }}</p>
</div>

<form id="workflowForm">
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">Workflow Details</h2>
            <div class="card-actions">
                <label class="status-badge {{ workflow.status|lower if workflow else 'inactive' }}" style="cursor: pointer;">
                    <input type="checkbox" id="workflowActive" name="active" {{ 'checked' if workflow and workflow.status == 'active' else '' }} style="display: none;">
                    <span class="status-badge-dot"></span>
                    <span id="statusText">{{ workflow.status|default('Inactive') }}</span>
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label for="workflowName" class="form-label">Workflow Name</label>
            <input type="text" id="workflowName" name="name" class="form-input" value="{{ workflow.name|default('') }}" required placeholder="My Workflow">
        </div>
        
        <div class="form-group">
            <label for="workflowDescription" class="form-label">Description</label>
            <textarea id="workflowDescription" name="description" class="form-textarea" rows="3" placeholder="Describe what this workflow does...">{{ workflow.description|default('') }}</textarea>
        </div>
    </div>

    <!-- n8n Integration Section -->
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">n8n Integration</h2>
        </div>
        
        <div class="form-group">
            <label for="n8nWorkflowId" class="form-label">n8n Workflow ID</label>
            <input type="text" id="n8nWorkflowId" name="n8n_workflow_id" class="form-input" value="{{ workflow.n8n_workflow_id|default('') }}" placeholder="Enter n8n workflow ID">
            <p style="font-size: 0.875rem; color: var(--color-text-light); margin-top: var(--spacing-xs);">
                Connect this workflow to an n8n workflow by entering its ID.
            </p>
        </div>
        
        <div class="form-group">
            <label for="n8nApiUrl" class="form-label">n8n API URL</label>
            <input type="text" id="n8nApiUrl" name="n8n_api_url" class="form-input" value="{{ workflow.n8n_api_url|default('') }}" placeholder="https://your-n8n-instance.com">
        </div>
        
        <div class="form-group">
            <label for="n8nApiKey" class="form-label">n8n API Key</label>
            <input type="password" id="n8nApiKey" name="n8n_api_key" class="form-input" value="{{ workflow.n8n_api_key|default('') }}" placeholder="Enter n8n API key">
        </div>
        
        <div style="padding: var(--spacing-md); background: var(--color-bg-light); border-radius: var(--radius-md); margin-top: var(--spacing-md);">
            <p style="font-size: 0.875rem; color: var(--color-text-light); margin: 0;">
                <strong>Note:</strong> n8n integration allows you to manage and execute workflows directly from Syntra. 
                Make sure your n8n instance is accessible and the API key has the necessary permissions.
            </p>
        </div>
    </div>

    <!-- Execution History -->
    {% if workflow and workflow.executions %}
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">Execution History</h2>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for execution in workflow.executions[:10] %}
                    <tr>
                        <td>{{ execution.created_at }}</td>
                        <td>
                            <span class="status-badge {{ execution.status|lower }}">
                                <span class="status-badge-dot"></span>
                                {{ execution.status }}
                            </span>
                        </td>
                        <td>{{ execution.duration|default('N/A') }}</td>
                        <td>
                            <button onclick="viewExecution('{{ execution.id }}')" class="btn btn-secondary btn-sm">View</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
        <button type="submit" class="btn btn-primary">Save Workflow</button>
        {% if workflow %}
        <button type="button" onclick="runWorkflow('{{ workflow.id }}')" class="btn btn-secondary">Run Now</button>
        <a href="{{ url_for('dashboard_workflows') }}" class="btn btn-secondary">Cancel</a>
        {% else %}
        <a href="{{ url_for('dashboard_workflows') }}" class="btn btn-secondary">Cancel</a>
        {% endif %}
    </div>
</form>
{% endblock %}

{% block dashboard_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const activeCheckbox = document.getElementById('workflowActive');
    const statusText = document.getElementById('statusText');
    const statusBadge = activeCheckbox.closest('.status-badge');
    
    activeCheckbox.addEventListener('change', function() {
        if (this.checked) {
            statusText.textContent = 'Active';
            statusBadge.className = 'status-badge active';
        } else {
            statusText.textContent = 'Inactive';
            statusBadge.className = 'status-badge inactive';
        }
    });
    
    // Form submission
    const form = document.getElementById('workflowForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        data.active = activeCheckbox.checked;
        
        const url = {% if workflow %}'/api/workflows/{{ workflow.id }}'{% else %}'/api/workflows'{% endif %};
        const method = {% if workflow %}'PUT'{% else %}'POST'{% endif %};
        
        fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                window.location.href = '{{ url_for("dashboard_workflows") }}';
            }
        })
        .catch(err => alert('Error: ' + err));
    });
});

function runWorkflow(workflowId) {
    if (confirm('Run this workflow now?')) {
        fetch(`/api/workflows/${workflowId}/run`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Workflow started successfully');
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
    }
}

function viewExecution(executionId) {
    // Placeholder for viewing execution details
    alert('Execution details view coming soon');
}
</script>
{% endblock %}

