{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<a href="{{ url_for('dashboard_workflows') }}">Workflows</a>
<span class="breadcrumbs-separator">/</span>
<span>{{ workflow.name }}</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">{{ workflow.name }}</h1>
    <p class="page-description">{{ workflow.description or 'Configure and manage this workflow' }}</p>
</div>

{% if not activation %}
<!-- Not Activated -->
<div class="dashboard-card" style="background: var(--color-primary-light); border-color: var(--color-primary);">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <i data-lucide="info" width="24" height="24" style="color: var(--color-primary);"></i>
        <div style="flex: 1;">
            <h3 style="font-size: var(--text-base); font-weight: var(--font-semibold); margin-bottom: 0.25rem;">Workflow Not Activated</h3>
            <p style="font-size: var(--text-sm); color: var(--color-text-light); margin: 0;">
                Activate this workflow to start using it. You'll need to configure API keys for required services.
            </p>
        </div>
        <button onclick="activateWorkflow()" class="btn btn-primary">Activate Workflow</button>
    </div>
</div>
{% else %}
<!-- Activated - Show Configuration -->
<div class="dashboard-card">
    <h2 class="card-title">Workflow Status</h2>
    <div style="display: flex; gap: 1rem; align-items: center;">
        <span class="status-badge active">
            <span class="status-badge-dot"></span>
            Activated
        </span>
        <span style="color: var(--color-text-light); font-size: var(--text-sm);">
            Executions: {{ activation.execution_count or 0 }}
        </span>
        {% if activation.last_executed_at %}
        <span style="color: var(--color-text-light); font-size: var(--text-sm);">
            Last run: {{ activation.last_executed_at[:19] }}
        </span>
        {% endif %}
    </div>
</div>

<!-- Required Services / API Keys -->
{% if required_services %}
<div class="dashboard-card" style="margin-top: 1.5rem;">
    <h2 class="card-title">Required API Keys</h2>
    <p style="color: var(--color-text-light); margin-bottom: 1rem;">Configure API keys for the services this workflow needs.</p>
    
    {% for service in required_services %}
    <div style="padding: 1rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <h3 style="font-size: var(--text-base); font-weight: var(--font-semibold); margin: 0;">{{ service|title }}</h3>
            {% set service_key = api_keys|selectattr('service_type', 'equalto', service)|first %}
            {% if service_key %}
            <span class="status-badge active">Configured</span>
            {% else %}
            <span class="status-badge inactive">Not Configured</span>
            {% endif %}
        </div>
        
        {% if service == 'notion' %}
        <p style="font-size: var(--text-sm); color: var(--color-text-light); margin-bottom: 0.75rem;">
            Get your Notion API key from: <a href="https://www.notion.so/my-integrations" target="_blank">Notion Integrations</a>
        </p>
        {% elif service == 'google-docs' %}
        <p style="font-size: var(--text-sm); color: var(--color-text-light); margin-bottom: 0.75rem;">
            Get your Google API key from: <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>
        </p>
        {% elif service == 'openai' %}
        <p style="font-size: var(--text-sm); color: var(--color-text-light); margin-bottom: 0.75rem;">
            Get your OpenAI API key from: <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
        </p>
        {% endif %}
        
        <div style="display: flex; gap: 0.5rem;">
            <input type="password" id="api_key_{{ service }}" class="form-input" placeholder="Enter {{ service }} API key" 
                   value="{{ service_key.api_key if service_key else '' }}" style="flex: 1;">
            <button onclick="saveApiKey('{{ service }}')" class="btn btn-primary btn-sm">Save</button>
            {% if service_key %}
            <button onclick="deleteApiKey('{{ service }}')" class="btn btn-danger btn-sm">Remove</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Run Workflow -->
<div class="dashboard-card" style="margin-top: 1.5rem;">
    <h2 class="card-title">Run Workflow</h2>
    <p style="color: var(--color-text-light); margin-bottom: 1rem;">Execute this workflow manually.</p>
    <button onclick="runWorkflow()" class="btn btn-primary">
        <i data-lucide="play" width="16" height="16"></i>
        Run Workflow
    </button>
</div>

<!-- Execution History -->
<div class="dashboard-card" style="margin-top: 1.5rem;">
    <h2 class="card-title">Execution History</h2>
    {% if executions %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Started</th>
                    <th>Duration</th>
                    <th>Error</th>
                </tr>
            </thead>
            <tbody>
                {% for exec in executions %}
                <tr>
                    <td>
                        <span class="status-badge {{ exec.status }}">
                            {{ exec.status }}
                        </span>
                    </td>
                    <td>{{ exec.started_at[:19] if exec.started_at else 'N/A' }}</td>
                    <td>{{ exec.duration_ms }}ms</td>
                    <td style="color: var(--color-danger);">{{ exec.error_message[:50] if exec.error_message else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: var(--color-text-light);">No executions yet.</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block dashboard_scripts %}
<script>
function activateWorkflow() {
    fetch('/api/workflows/{{ workflow.id }}/activate', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                location.reload();
            }
        })
        .catch(err => alert('Error: ' + err));
}

function saveApiKey(serviceType) {
    const input = document.getElementById('api_key_' + serviceType);
    const apiKey = input.value.trim();
    
    if (!apiKey) {
        alert('Please enter an API key');
        return;
    }
    
    fetch('/api/workflows/{{ workflow.id }}/api-keys', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ service_type: serviceType, api_key: apiKey })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('API key saved successfully!');
            location.reload();
        }
    })
    .catch(err => alert('Error: ' + err));
}

function deleteApiKey(serviceType) {
    if (!confirm('Remove this API key?')) return;
    
    // Note: This would require a DELETE endpoint
    alert('API key removal not yet implemented');
}

function runWorkflow() {
    if (!confirm('Run this workflow now?')) return;
    
    fetch('/api/workflows/{{ workflow.id }}/run', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert('Workflow started successfully!');
                location.reload();
            }
        })
        .catch(err => alert('Error: ' + err));
}

document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
