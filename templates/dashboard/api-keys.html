{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<span>API Keys</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <div style="display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 class="page-title">API Keys</h1>
            <p class="page-description">Manage your API keys for external integrations.</p>
        </div>
        <button onclick="toggleAddForm()" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="plus" width="16" height="16"></i>
            Add API Key
        </button>
    </div>
</div>

<!-- API Keys List -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">Your API Keys</h2>
        <span style="font-size: var(--text-sm); color: var(--color-text-light);">{{ api_keys|length if api_keys else 0 }} keys</span>
    </div>
    
    {% if api_keys %}
    <div class="card-grid">
        {% for key in api_keys %}
        <div class="card-item">
            <div class="card-item-header">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <i data-lucide="key" width="20" height="20" style="color: var(--color-primary);"></i>
                        <h3 class="card-item-title">{{ key.name }}</h3>
                    </div>
                    <span class="status-badge {{ 'active' if key.is_active else 'inactive' }}">
                        <span class="status-badge-dot"></span>
                        {{ 'Active' if key.is_active else 'Inactive' }}
                    </span>
                </div>
            </div>
            <div class="card-item-body">
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; font-size: var(--text-sm);">
                    <span style="color: var(--color-text-light);">Type:</span>
                    <span style="font-weight: var(--font-medium);">{{ key.type }}</span>
                    {% if key.created_at %}
                    <span style="color: var(--color-text-light);">Created:</span>
                    <span>{{ key.created_at }}</span>
                    {% endif %}
                    {% if key.last_used %}
                    <span style="color: var(--color-text-light);">Last Used:</span>
                    <span>{{ key.last_used }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-item-footer" style="flex-direction: column; align-items: stretch; gap: 0.75rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; background: var(--color-bg-muted); padding: 0.5rem; border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                    <input type="password" value="{{ key.key_value }}" readonly class="key-value-input" style="flex: 1; padding: 0; border: none; font-size: var(--text-xs); font-family: var(--font-mono); background: transparent; outline: none;">
                    <button class="copy-btn" data-copy="{{ key.key_value }}" style="display: inline-flex; align-items: center; gap: 0.375rem;">
                        <i data-lucide="copy" width="14" height="14"></i>
                        Copy
                    </button>
                </div>
                <button onclick="deleteKey('{{ key.id }}')" class="btn btn-danger btn-sm" style="display: inline-flex; align-items: center; gap: 0.375rem; width: 100%;">
                    <i data-lucide="trash-2" width="14" height="14"></i>
                    Delete Key
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i data-lucide="key" width="32" height="32"></i>
        </div>
        <h3 class="empty-state-title">No API keys yet</h3>
        <p class="empty-state-description">Add your first API key to connect external services.</p>
        <button onclick="toggleAddForm()" class="btn btn-primary">Add API Key</button>
    </div>
    {% endif %}
</div>

<!-- Add API Key Form -->
<div id="addKeyFormContainer" class="dashboard-card" style="display: none;">
    <div class="card-header">
        <h2 class="card-title">Add New API Key</h2>
    </div>
    <form id="addKeyForm">
        <div class="form-group">
            <label for="keyName" class="form-label">Name</label>
            <input type="text" id="keyName" name="name" required class="form-input" placeholder="e.g., OpenAI API Key">
        </div>
        <div class="form-group">
            <label for="keyType" class="form-label">Type</label>
            <select id="keyType" name="type" required class="form-input">
                <option value="">Select type...</option>
                <option value="OpenAI">OpenAI</option>
                <option value="Notion">Notion</option>
                <option value="n8n">n8n</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label for="keyValue" class="form-label">Key Value</label>
            <input type="password" id="keyValue" name="key" required class="form-input" placeholder="Enter API key">
            <p style="font-size: 0.875rem; color: var(--color-text-light); margin-top: var(--spacing-xs);">
                Your API key will be encrypted and stored securely.
            </p>
        </div>
        <div style="display: flex; gap: var(--spacing-md);">
            <button type="submit" class="btn btn-primary">Add Key</button>
            <button type="button" onclick="toggleAddForm()" class="btn btn-secondary">Cancel</button>
        </div>
    </form>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
function toggleAddForm() {
    const formContainer = document.getElementById('addKeyFormContainer');
    const isHidden = formContainer.style.display === 'none' || !formContainer.style.display;
    formContainer.style.display = isHidden ? 'block' : 'none';
    if (isHidden) {
        document.getElementById('keyName').focus();
        // Scroll to form
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

function deleteKey(keyId) {
    if (confirm('Are you sure you want to delete this API key? This action cannot be undone.')) {
        fetch('/api/keys/' + keyId, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
    }
}

// Copy functionality
document.addEventListener('DOMContentLoaded', function() {
    // Handle copy buttons
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const textToCopy = this.getAttribute('data-copy');
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i data-lucide="check" width="14" height="14"></i> Copied!';
                this.classList.add('copied');
                
                // Reinitialize icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
                setTimeout(() => {
                    this.innerHTML = originalHTML;
                    this.classList.remove('copied');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        });
    });
    
    // Initialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});

// Form submission
handleFormSubmit('addKeyForm', '/api/keys', () => {
    location.reload();
}, (error) => {
    alert('Error: ' + error);
});
</script>
{% endblock %}

