{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<span>API Keys</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">API Keys</h1>
    <p class="page-description">Manage your API keys for external integrations.</p>
</div>

<!-- API Keys List -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">Your API Keys</h2>
        <button onclick="toggleAddForm()" class="btn btn-primary btn-sm">Add API Key</button>
    </div>
    
    {% if api_keys %}
    <div class="card-grid">
        {% for key in api_keys %}
        <div class="card-item">
            <div class="card-item-header">
                <div>
                    <h3 class="card-item-title">{{ key.name }}</h3>
                    <span class="status-badge {{ 'active' if key.is_active else 'inactive' }}">
                        <span class="status-badge-dot"></span>
                        {{ 'Active' if key.is_active else 'Inactive' }}
                    </span>
                </div>
            </div>
            <div class="card-item-body">
                <p style="margin-bottom: var(--spacing-sm);"><strong>Type:</strong> {{ key.type }}</p>
                {% if key.created_at %}
                <p style="margin-bottom: var(--spacing-sm);"><strong>Created:</strong> {{ key.created_at }}</p>
                {% endif %}
                {% if key.last_used %}
                <p style="margin-bottom: var(--spacing-sm);"><strong>Last Used:</strong> {{ key.last_used }}</p>
                {% endif %}
            </div>
            <div class="card-item-footer">
                <div style="flex: 1; display: flex; align-items: center; gap: var(--spacing-sm);">
                    <input type="text" value="{{ key.key_value }}" readonly style="flex: 1; padding: var(--spacing-xs) var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 0.875rem; font-family: var(--font-mono); background: var(--color-bg-light);">
                    <button class="copy-btn" data-copy="{{ key.key_value }}">Copy</button>
                </div>
                <button onclick="deleteKey('{{ key.id }}')" class="btn btn-danger btn-sm">Delete</button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ”‘</div>
        <h3 class="empty-state-title">No API keys yet</h3>
        <p class="empty-state-description">Add your first API key to connect external services.</p>
        <button onclick="toggleAddForm()" class="btn btn-primary">Add API Key</button>
    </div>
    {% endif %}
</div>

<!-- Add API Key Form -->
<div id="addKeyFormContainer" class="dashboard-card" style="display: none;">
    <div class="card-header">
        <h2 class="card-title">Add New API Key</h2>
    </div>
    <form id="addKeyForm">
        <div class="form-group">
            <label for="keyName" class="form-label">Name</label>
            <input type="text" id="keyName" name="name" required class="form-input" placeholder="e.g., OpenAI API Key">
        </div>
        <div class="form-group">
            <label for="keyType" class="form-label">Type</label>
            <select id="keyType" name="type" required class="form-input">
                <option value="">Select type...</option>
                <option value="OpenAI">OpenAI</option>
                <option value="Notion">Notion</option>
                <option value="n8n">n8n</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label for="keyValue" class="form-label">Key Value</label>
            <input type="password" id="keyValue" name="key" required class="form-input" placeholder="Enter API key">
            <p style="font-size: 0.875rem; color: var(--color-text-light); margin-top: var(--spacing-xs);">
                Your API key will be encrypted and stored securely.
            </p>
        </div>
        <div style="display: flex; gap: var(--spacing-md);">
            <button type="submit" class="btn btn-primary">Add Key</button>
            <button type="button" onclick="toggleAddForm()" class="btn btn-secondary">Cancel</button>
        </div>
    </form>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
function toggleAddForm() {
    const formContainer = document.getElementById('addKeyFormContainer');
    formContainer.style.display = formContainer.style.display === 'none' ? 'block' : 'none';
    if (formContainer.style.display === 'block') {
        document.getElementById('keyName').focus();
    }
}

function deleteKey(keyId) {
    if (confirm('Are you sure you want to delete this API key? This action cannot be undone.')) {
        fetch('/api/keys/' + keyId, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
    }
}

// Form submission
handleFormSubmit('addKeyForm', '/api/keys', () => {
    location.reload();
}, (error) => {
    alert('Error: ' + error);
});
</script>
{% endblock %}

