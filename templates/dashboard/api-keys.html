{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<span>API Keys</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header"
    style="display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1 class="page-title">API Keys</h1>
        <p class="page-description">Manage API keys for external integrations.</p>
    </div>
    <button onclick="toggleAddForm()" class="btn btn-primary btn-sm">
        <i data-lucide="plus" width="14" height="14"></i>
        Add Key
    </button>
</div>

<!-- Add API Key Form (Hidden by default) -->
<div id="addKeyFormContainer" class="dashboard-card" style="display: none;">
    <div class="card-header">
        <h2 class="card-title">Add New API Key</h2>
    </div>
    <form id="addKeyForm">
        <div class="form-group">
            <label for="keyName" class="form-label">Name</label>
            <input type="text" id="keyName" name="name" required class="form-input" placeholder="e.g., OpenAI API Key">
        </div>
        <div class="form-group">
            <label for="keyType" class="form-label">Type</label>
            <select id="keyType" name="type" required class="form-input">
                <option value="">Select type...</option>
                <option value="OpenAI">OpenAI</option>
                <option value="Notion">Notion</option>

                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label for="keyValue" class="form-label">Key Value</label>
            <input type="password" id="keyValue" name="key" required class="form-input" placeholder="Enter API key">
            <p class="form-help-text">Your key will be encrypted and stored securely.</p>
        </div>
        <div style="display: flex; gap: 8px;">
            <button type="submit" class="btn btn-primary btn-sm">Add Key</button>
            <button type="button" onclick="toggleAddForm()" class="btn btn-secondary btn-sm">Cancel</button>
        </div>
    </form>
</div>

<!-- API Keys List -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">Your API Keys</h2>
        <span style="font-size: var(--db-text-xs); color: var(--db-text-tertiary);">{{ api_keys|length if api_keys else
            0 }} keys</span>
    </div>

    {% if api_keys %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Key</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for key in api_keys %}
                <tr>
                    <td style="font-weight: 500;">{{ key.name }}</td>
                    <td style="color: var(--db-text-secondary);">{{ key.type }}</td>
                    <td>
                        <span class="status-badge {{ 'active' if key.is_active else 'inactive' }}">
                            {{ 'Active' if key.is_active else 'Inactive' }}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <code
                                style="font-size: var(--db-text-xs); color: var(--db-text-tertiary);">••••••{{ key.key_value[-4:] if key.key_value|length > 4 else '••••' }}</code>
                            <button class="copy-btn" data-copy="{{ key.key_value }}">
                                <i data-lucide="copy" width="12" height="12"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <button onclick="deleteKey('{{ key.id }}')" class="btn btn-danger btn-sm">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i data-lucide="key" width="24" height="24"></i>
        </div>
        <h3 class="empty-state-title">No API keys yet</h3>
        <p class="empty-state-description">Add your first API key to connect external services.</p>
        <button onclick="toggleAddForm()" class="btn btn-primary btn-sm">Add API Key</button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
    function toggleAddForm() {
        const formContainer = document.getElementById('addKeyFormContainer');
        const isHidden = formContainer.style.display === 'none';
        formContainer.style.display = isHidden ? 'block' : 'none';
        if (isHidden) {
            document.getElementById('keyName').focus();
            formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function deleteKey(keyId) {
        if (confirm('Delete this API key?')) {
            fetch('/api/keys/' + keyId, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) alert('Error: ' + data.error);
                    else location.reload();
                })
                .catch(err => alert('Error: ' + err));
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Copy functionality
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const textToCopy = this.getAttribute('data-copy');
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const icon = this.querySelector('i');
                    icon.setAttribute('data-lucide', 'check');
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                    setTimeout(() => {
                        icon.setAttribute('data-lucide', 'copy');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }, 2000);
                });
            });
        });

        if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    // Form submission
    if (typeof handleFormSubmit !== 'undefined') {
        handleFormSubmit('addKeyForm', '/api/keys', () => location.reload(), (error) => alert('Error: ' + error));
    }
</script>
{% endblock %}