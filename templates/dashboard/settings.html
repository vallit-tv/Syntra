{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<span>Settings</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">Settings</h1>
    <p class="page-description">Manage your account settings and preferences.</p>
</div>

<!-- User Profile -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">Profile</h2>
    </div>
    <form id="profileForm">
        <div class="form-group">
            <label for="userName" class="form-label">Name</label>
            <input type="text" id="userName" name="name" class="form-input" value="{{ user.name }}" required>
        </div>
        <div class="form-group">
            <label class="form-label">Role</label>
            <input type="text" class="form-input" value="{{ user.get('role', 'user')|capitalize }}" disabled style="background: var(--color-bg-light);">
            <p style="font-size: 0.875rem; color: var(--color-text-light); margin-top: var(--spacing-xs);">
                Your role is managed by administrators.
            </p>
        </div>
        <div class="form-group">
            <label class="form-label">Account Created</label>
            <input type="text" class="form-input" value="{{ user.get('created_at', 'Unknown') }}" disabled style="background: var(--color-bg-light);">
        </div>
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </form>
</div>

<!-- Password Settings -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">Password</h2>
    </div>
    <form id="passwordForm">
        <div class="form-group">
            <label for="currentPassword" class="form-label">Current Password</label>
            <input type="password" id="currentPassword" name="current_password" class="form-input" required>
        </div>
        <div class="form-group">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" id="newPassword" name="new_password" class="form-input" required minlength="8">
        </div>
        <div class="form-group">
            <label for="confirmPassword" class="form-label">Confirm New Password</label>
            <input type="password" id="confirmPassword" name="confirm_password" class="form-input" required minlength="8">
        </div>
        <button type="submit" class="btn btn-primary">Change Password</button>
    </form>
</div>

<!-- Workflow Defaults -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">Workflow Defaults</h2>
    </div>
    <form id="workflowDefaultsForm">
        <div class="form-group">
            <label for="defaultN8nUrl" class="form-label">Default n8n API URL</label>
            <input type="text" id="defaultN8nUrl" name="default_n8n_url" class="form-input" value="{{ workflow_defaults.get('n8n_url', '') }}" placeholder="https://your-n8n-instance.com">
            <p style="font-size: 0.875rem; color: var(--color-text-light); margin-top: var(--spacing-xs);">
                This URL will be used as default when creating new workflows.
            </p>
        </div>
        <button type="submit" class="btn btn-primary">Save Defaults</button>
    </form>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
// Profile form
handleFormSubmit('profileForm', '/api/user/profile', () => {
    alert('Profile updated successfully');
    location.reload();
}, (error) => {
    alert('Error: ' + error);
});

// Password form
const passwordForm = document.getElementById('passwordForm');
if (passwordForm) {
    passwordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(passwordForm);
        const data = Object.fromEntries(formData);
        
        if (data.new_password !== data.confirm_password) {
            alert('New passwords do not match');
            return;
        }
        
        fetch('/api/user/password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert('Password changed successfully');
                passwordForm.reset();
            }
        })
        .catch(err => alert('Error: ' + err));
    });
}

// Workflow defaults form
handleFormSubmit('workflowDefaultsForm', '/api/user/workflow-defaults', () => {
    alert('Workflow defaults saved successfully');
}, (error) => {
    alert('Error: ' + error);
});
</script>
{% endblock %}

