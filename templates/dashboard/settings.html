{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<span>Settings</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <h1 class="page-title">Settings</h1>
    <p class="page-description">Manage your account settings.</p>
</div>

<!-- Profile -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">Profile</h2>
    </div>
    <form id="profileForm">
        <div class="form-group">
            <label for="userName" class="form-label">Name</label>
            <input type="text" id="userName" name="name" class="form-input" value="{{ user.name }}" required>
        </div>
        <div class="form-group">
            <label class="form-label">Role</label>
            <input type="text" class="form-input" value="{{ user.get('role', 'user')|capitalize }}" disabled
                style="background: var(--db-bg-secondary); color: var(--db-text-tertiary);">
        </div>
        <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
    </form>
</div>

<!-- Password -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">Password</h2>
    </div>
    <form id="passwordForm">
        <div class="form-group">
            <label for="currentPassword" class="form-label">Current Password</label>
            <input type="password" id="currentPassword" name="current_password" class="form-input" required>
        </div>
        <div class="form-group">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" id="newPassword" name="new_password" class="form-input" required minlength="8">
        </div>
        <div class="form-group">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <input type="password" id="confirmPassword" name="confirm_password" class="form-input" required
                minlength="8">
        </div>
        <button type="submit" class="btn btn-primary btn-sm">Change Password</button>
    </form>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
    // Profile form
    if (typeof handleFormSubmit !== 'undefined') {
        handleFormSubmit('profileForm', '/api/user/profile', () => {
            location.reload();
        }, (error) => alert('Error: ' + error));
    }

    // Password form
    const passwordForm = document.getElementById('passwordForm');
    if (passwordForm) {
        passwordForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(passwordForm);
            const data = Object.fromEntries(formData);

            if (data.new_password !== data.confirm_password) {
                alert('Passwords do not match');
                return;
            }

            fetch('/api/user/password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) alert('Error: ' + data.error);
                    else {
                        alert('Password changed');
                        passwordForm.reset();
                    }
                })
                .catch(err => alert('Error: ' + err));
        });
    }
</script>
{% endblock %}