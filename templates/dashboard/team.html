{% extends "dashboard/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('dashboard_overview') }}">Dashboard</a>
<span class="breadcrumbs-separator">/</span>
<span>Team</span>
{% endblock %}

{% block dashboard_content %}
<div class="page-header">
    <div style="display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 class="page-title">Team Members</h1>
            <p class="page-description">Invite and manage your team members and their roles.</p>
        </div>
        <button onclick="toggleInviteForm()" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
            <i data-lucide="user-plus" width="16" height="16"></i>
            Invite Member
        </button>
    </div>
</div>

<!-- Invite Form (Hidden by default) -->
<div id="inviteFormContainer" class="dashboard-card" style="display: none; background: var(--color-primary-light); border-color: var(--color-primary);">
    <div class="card-header">
        <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="mail" width="20" height="20"></i>
            Invite Team Member
        </h2>
    </div>
    <form id="inviteForm">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="inviteEmail" class="form-label">Email Address</label>
                <input type="email" id="inviteEmail" name="email" required class="form-input" placeholder="colleague@company.com">
            </div>
            <div class="form-group">
                <label for="inviteRole" class="form-label">Role</label>
                <select id="inviteRole" name="role" required class="form-input">
                    <option value="viewer">Viewer - Read-only access</option>
                    <option value="member">Member - Can view and edit</option>
                    <option value="editor">Editor - Can manage workflows</option>
                    <option value="admin">Admin - Full access</option>
                </select>
            </div>
        </div>
        <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
            <button type="submit" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="send" width="16" height="16"></i>
                Send Invitation
            </button>
            <button type="button" onclick="toggleInviteForm()" class="btn btn-secondary">Cancel</button>
        </div>
    </form>
</div>

<!-- Pending Invitations -->
{% if pending_invitations %}
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="mail" width="20" height="20"></i>
            Pending Invitations
        </h2>
        <span style="font-size: var(--text-sm); color: var(--color-text-light);">{{ pending_invitations|length }} pending</span>
    </div>
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Invited By</th>
                    <th>Expires</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for invitation in pending_invitations %}
                <tr>
                    <td>{{ invitation.email }}</td>
                    <td>
                        <span class="status-badge inactive">{{ invitation.role }}</span>
                    </td>
                    <td>{{ invitation.invited_by_name|default('Unknown') }}</td>
                    <td>{{ invitation.expires_at|default('N/A') }}</td>
                    <td>
                        <div class="table-actions">
                            <button onclick="resendInvite('{{ invitation.id }}')" class="btn btn-secondary btn-sm" style="display: inline-flex; align-items: center; gap: 0.375rem;">
                                <i data-lucide="mail" width="14" height="14"></i>
                                Resend
                            </button>
                            <button onclick="cancelInvite('{{ invitation.id }}')" class="btn btn-danger btn-sm" style="display: inline-flex; align-items: center; gap: 0.375rem;">
                                <i data-lucide="x" width="14" height="14"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Active Team Members -->
<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
            <i data-lucide="users" width="20" height="20"></i>
            Team Members
        </h2>
        <span style="font-size: var(--text-sm); color: var(--color-text-light);">{{ team_members|length if team_members else 0 }} members</span>
    </div>
    
    {% if team_members %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Member</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for member in team_members %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 32px; height: 32px; border-radius: var(--radius-md); background: var(--color-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: var(--font-semibold); font-size: var(--text-sm);">
                                {{ member.name[0].upper() if member.name else '?' }}
                            </div>
                            <div>
                                <div style="font-weight: var(--font-medium);">{{ member.name }}</div>
                                {% if member.is_current_user %}
                                <span style="font-size: var(--text-xs); color: var(--color-text-light);">(You)</span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>{{ member.email }}</td>
                    <td>
                        <select 
                            onchange="updateMemberRole('{{ member.id }}', this.value)" 
                            class="filter-select" 
                            style="padding: 0.25rem 0.5rem; font-size: var(--text-xs);"
                            {% if member.is_current_user or not current_user_can_manage %}disabled{% endif %}>
                            <option value="viewer" {% if member.role == 'viewer' %}selected{% endif %}>Viewer</option>
                            <option value="member" {% if member.role == 'member' %}selected{% endif %}>Member</option>
                            <option value="editor" {% if member.role == 'editor' %}selected{% endif %}>Editor</option>
                            <option value="admin" {% if member.role == 'admin' %}selected{% endif %}>Admin</option>
                        </select>
                    </td>
                    <td>{{ member.joined_at|default('N/A') }}</td>
                    <td>
                        <div class="table-actions">
                            {% if not member.is_current_user and current_user_can_manage %}
                            <button onclick="removeMember('{{ member.id }}')" class="btn btn-danger btn-sm" style="display: inline-flex; align-items: center; gap: 0.375rem;">
                                <i data-lucide="user-minus" width="14" height="14"></i>
                                Remove
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i data-lucide="users" width="32" height="32"></i>
        </div>
        <h3 class="empty-state-title">No team members yet</h3>
        <p class="empty-state-description">Invite your first team member to get started.</p>
        <button onclick="toggleInviteForm()" class="btn btn-primary">Invite Member</button>
    </div>
    {% endif %}
</div>

<!-- Role Permissions Info -->
<div class="dashboard-card" style="background: var(--color-bg-subtle); border-style: dashed;">
    <h3 style="font-size: var(--text-base); font-weight: var(--font-semibold); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
        <i data-lucide="info" width="20" height="20"></i>
        Role Permissions
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div>
            <h4 style="font-weight: var(--font-semibold); margin-bottom: 0.5rem; font-size: var(--text-sm);">Viewer</h4>
            <ul style="font-size: var(--text-sm); color: var(--color-text-light); padding-left: 1.25rem;">
                <li>View workflows</li>
                <li>View API keys</li>
                <li>View integrations</li>
            </ul>
        </div>
        <div>
            <h4 style="font-weight: var(--font-semibold); margin-bottom: 0.5rem; font-size: var(--text-sm);">Member</h4>
            <ul style="font-size: var(--text-sm); color: var(--color-text-light); padding-left: 1.25rem;">
                <li>All Viewer permissions</li>
                <li>Create and edit workflows</li>
                <li>Run workflows</li>
            </ul>
        </div>
        <div>
            <h4 style="font-weight: var(--font-semibold); margin-bottom: 0.5rem; font-size: var(--text-sm);">Editor</h4>
            <ul style="font-size: var(--text-sm); color: var(--color-text-light); padding-left: 1.25rem;">
                <li>All Member permissions</li>
                <li>Manage API keys</li>
                <li>Configure integrations</li>
                <li>Delete workflows</li>
            </ul>
        </div>
        <div>
            <h4 style="font-weight: var(--font-semibold); margin-bottom: 0.5rem; font-size: var(--text-sm);">Admin</h4>
            <ul style="font-size: var(--text-sm); color: var(--color-text-light); padding-left: 1.25rem;">
                <li>All Editor permissions</li>
                <li>Manage team members</li>
                <li>Billing and subscriptions</li>
                <li>Organization settings</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
function toggleInviteForm() {
    const formContainer = document.getElementById('inviteFormContainer');
    const isHidden = formContainer.style.display === 'none' || !formContainer.style.display;
    formContainer.style.display = isHidden ? 'block' : 'none';
    if (isHidden) {
        document.getElementById('inviteEmail').focus();
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    // Reinitialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function resendInvite(inviteId) {
    if (confirm('Resend invitation email?')) {
        fetch(`/api/team/invitations/${inviteId}/resend`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Invitation resent successfully!');
                }
            })
            .catch(err => alert('Error: ' + err));
    }
}

function cancelInvite(inviteId) {
    if (confirm('Cancel this invitation? This action cannot be undone.')) {
        fetch(`/api/team/invitations/${inviteId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
    }
}

function updateMemberRole(memberId, newRole) {
    fetch(`/api/team/members/${memberId}/role`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: newRole })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            location.reload(); // Reset the select
        } else {
            alert('Role updated successfully!');
        }
    })
    .catch(err => {
        alert('Error: ' + err);
        location.reload();
    });
}

function removeMember(memberId) {
    if (confirm('Remove this team member? They will lose access to the organization.')) {
        fetch(`/api/team/members/${memberId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
    }
}

// Form submission
document.addEventListener('DOMContentLoaded', function() {
    const inviteForm = document.getElementById('inviteForm');
    if (inviteForm) {
        inviteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            fetch('/api/team/invitations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    alert('Invitation sent successfully!');
                    location.reload();
                }
            })
            .catch(err => alert('Error: ' + err));
        });
    }
    
    // Initialize icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}

