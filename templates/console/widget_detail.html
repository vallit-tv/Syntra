{% extends "layout_console.html" %}

{% block page_title %}Widget Details{% endblock %}

{% block content %}
<div style="max-width: 1000px;">

    <!-- HEADER -->
    <div style="margin-bottom: var(--space-xl);">
        <div
            style="font-size: 12px; color: var(--console-text-tertiary); margin-bottom: var(--space-sm); display: flex; align-items: center; gap: 8px;">
            <a href="{{ url_for('admin_company_detail', company_id=company.id) }}"
                style="color: inherit; text-decoration: none; hover: underline;">{{ company.name }}</a>
            <i data-lucide="chevron-right" width="12" height="12"></i>
            <span>Chat Widget</span>
        </div>

        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h1 style="font-size: 20px; font-weight: 600; margin: 0 0 4px 0;">Widget Configuration</h1>
                <div class="subtitle">
                    ID: <span style="font-family: monospace;">{{ company.id }}</span>
                </div>
            </div>
            <div style="display: flex; gap: var(--space-sm);">
                <button class="btn btn-secondary" onclick="copyEmbedCode()">
                    <i data-lucide="code" width="14" height="14"></i>
                    Copy Embed Code
                </button>
            </div>
        </div>
    </div>

    <div class="grid" style="grid-template-columns: 2fr 1fr; gap: var(--space-xl);">

        <!-- MAIN COLUMN -->
        <div>
            <!-- STATS -->
            <div class="status-grid" style="margin-bottom: var(--space-xl);">
                <div class="status-item">
                    <span class="status-label">Sessions (Today)</span>
                    <div class="status-value">{{ stats_today.sessions }}</div>
                </div>
                <div class="status-item">
                    <span class="status-label">Messages (Today)</span>
                    <div class="status-value">{{ stats_today.messages }}</div>
                </div>
                <div class="status-item">
                    <span class="status-label">Avg Duration</span>
                    <div class="status-value">{{ "%.1f"|format(stats_today.avg_duration|default(0)) }}s</div>
                </div>
            </div>

            <!-- RECENT SESSIONS -->
            <h2 style="font-size: 14px; font-weight: 500; margin-bottom: var(--space-md);">Recent Sessions</h2>
            <div class="panel" style="padding: 0; overflow: hidden; margin-bottom: var(--space-xl);">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead
                        style="border-bottom: 1px solid var(--console-border); background: var(--console-bg-secondary);">
                        <tr>
                            <th
                                style="text-align: left; padding: 12px; font-weight: 500; color: var(--console-text-secondary); padding-left: 20px;">
                                Session ID</th>
                            <th
                                style="text-align: left; padding: 12px; font-weight: 500; color: var(--console-text-secondary);">
                                Started</th>
                            <th
                                style="text-align: center; padding: 12px; font-weight: 500; color: var(--console-text-secondary);">
                                Messages</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for session in recent_sessions %}
                        <tr style="border-bottom: 1px solid var(--console-border);">
                            <td
                                style="padding: 12px 12px 12px 20px; font-family: monospace; color: var(--console-text-primary);">
                                {{ session.id[:8] }}...
                            </td>
                            <td style="padding: 12px; color: var(--console-text-secondary);">
                                {{ session.created_at|datetime }}
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span class="badge">{{ session.message_count }}</span>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3"
                                style="padding: 24px; text-align: center; color: var(--console-text-tertiary);">
                                No recent sessions found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- CONFIGURATION FORM -->
            <h2 style="font-size: 14px; font-weight: 500; margin-bottom: var(--space-md);">Appearance & Settings</h2>
            <div class="panel">
                <form id="widgetConfigForm">
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px;">Widget
                                Title</label>
                            <input type="text" id="configTitle" value="{{ widget_config.title or 'Chat Support' }}"
                                class="console-input">
                        </div>
                        <div>
                            <label
                                style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px;">Primary
                                Color</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="color" id="configColorPicker"
                                    value="{{ widget_config.primary_color or '#000000' }}"
                                    style="height: 38px; width: 60px; padding: 2px; border: 1px solid var(--console-border); background: var(--console-bg-secondary); border-radius: 6px;">
                                <input type="text" id="configColor"
                                    value="{{ widget_config.primary_color or '#000000' }}" class="console-input"
                                    style="flex: 1;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: var(--space-lg);">
                        <label style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px;">Welcome
                            Message</label>
                        <textarea id="configWelcome" class="console-input"
                            rows="3">{{ widget_config.welcome_message or 'Hello! How can I help you today?' }}</textarea>
                    </div>

                    <div style="margin-top: var(--space-lg); display: flex; justify-content: flex-end;">
                        <button type="button" onclick="saveWidgetConfig()" class="btn btn-primary">Save
                            Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div>
            <div class="panel">
                <h3
                    style="font-size: 13px; font-weight: 600; margin: 0 0 var(--space-md) 0; color: var(--console-text-secondary);">
                    Installation</h3>
                <p style="font-size: 13px; color: var(--console-text-secondary); margin-bottom: var(--space-md);">
                    Add this code to your website's <code
                        style="background: var(--console-bg-secondary); padding: 2px 4px; border-radius: 4px;">&lt;body&gt;</code>
                    tag.
                </p>
                <textarea id="embedCodeArea" class="console-input" rows="8" readonly
                    style="font-family: monospace; font-size: 11px; color: var(--console-text-secondary);">{{ embed_code }}</textarea>
            </div>
        </div>
    </div>
</div>

<script>
    // Simple sync for color picker
    document.getElementById('configColorPicker').addEventListener('input', (e) => {
        document.getElementById('configColor').value = e.target.value;
    });
    document.getElementById('configColor').addEventListener('input', (e) => {
        document.getElementById('configColorPicker').value = e.target.value;
    });

    function copyEmbedCode() {
        const copyText = document.getElementById("embedCodeArea");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        alert("Embed code copied to clipboard!");
    }

    async function saveWidgetConfig() {
        const title = document.getElementById('configTitle').value;
        const color = document.getElementById('configColor').value;
        const welcome = document.getElementById('configWelcome').value;

        try {
            const response = await fetch('/api/admin/companies/{{ company.id }}/widget-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    settings: {
                        title: title,
                        primary_color: color,
                        welcome_message: welcome
                    }
                })
            });

            if (response.ok) {
                alert('Settings saved successfully!');
                window.location.reload();
            } else {
                alert('Failed to save settings.');
            }
        } catch (e) {
            console.error(e);
            alert('Error saving settings.');
        }
    }
</script>
{% endblock %}