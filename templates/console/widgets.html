{% extends "layout_console_v3.html" %}

{% block page_title %}Agents{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">

    <p class="text-muted">Manage chat agents for your companies. Configure settings and copy embed codes.</p>

    <!-- AGENTS TABLE -->
    <div class="card">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Activity (30d)</th>
                        <th>Status</th>
                        <th style="width: 160px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if companies %}
                    {% for company in companies %}
                    <tr>
                        <td>
                            <div class="flex items-center gap-3">
                                <div class="user-avatar" style="width: 32px; height: 32px; font-size: 12px;">
                                    {{ company.company_name[0]|upper if company.company_name else 'C' }}
                                </div>
                                <div>
                                    <div style="font-weight: 500; color: var(--text-primary);">{{ company.company_name
                                        }}</div>
                                    <div class="text-xs text-muted">{{ company.company_slug }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="flex flex-col gap-1">
                                <span>{{ company.total_messages }} messages</span>
                                <span class="text-xs text-muted">{{ company.total_sessions }} sessions</span>
                            </div>
                        </td>
                        <td>
                            <span
                                class="badge {% if company.has_activity %}badge-success{% else %}badge-default{% endif %}">
                                {{ 'Active' if company.has_activity else 'Idle' }}
                            </span>
                        </td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-ghost btn-icon btn-sm"
                                    onclick="copyEmbed('{{ company.company_id }}')" title="Copy Embed Code">
                                    <i data-lucide="code" width="14" height="14"></i>
                                </button>
                                <button class="btn btn-ghost btn-icon btn-sm"
                                    onclick="openSettings('{{ company.company_id }}', '{{ company.company_name }}')"
                                    title="Settings">
                                    <i data-lucide="settings" width="14" height="14"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i data-lucide="bot" width="24" height="24"></i>
                                </div>
                                <div class="empty-state-title">No agents yet</div>
                                <div class="empty-state-description">
                                    Create a company first in the Companies page to deploy chat agents.
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- EMBED INSTRUCTIONS -->
    <div class="card">
        <div class="card-header">
            <h3 class="heading-md">How to Embed</h3>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">Add the following script tag to your website's HTML, just before the closing
                <code>&lt;/body&gt;</code> tag:
            </p>
            <div
                style="background: var(--bg-tertiary); padding: var(--space-4); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 12px; overflow-x: auto;">
                <code
                    style="color: var(--text-secondary);">&lt;script src="{{ request.host_url }}widget/embed.js" data-company-id="YOUR_COMPANY_ID" data-theme="minimal"&gt;&lt;/script&gt;</code>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block modals %}
<!-- WIDGET SETTINGS MODAL -->
<div id="widget-settings-modal" class="modal-backdrop">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">Widget Settings</h3>
            <button class="modal-close" onclick="Vallit.Modal.close()">
                <i data-lucide="x" width="18" height="18"></i>
            </button>
        </div>
        <form id="widgetSettingsForm">
            <input type="hidden" id="settingsCompanyId">
            <div class="modal-body">
                <div class="flex flex-col gap-5">
                    <!-- Bot Name -->
                    <div class="form-group">
                        <label class="form-label">Bot Name</label>
                        <input type="text" id="settingsBotName" class="form-input w-full" placeholder="e.g., Kian">
                        <span class="form-hint">The name displayed in the chat widget header.</span>
                    </div>

                    <!-- Welcome Message -->
                    <div class="form-group">
                        <label class="form-label">Welcome Message</label>
                        <textarea id="settingsWelcomeMessage" class="form-input w-full" rows="2"
                            placeholder="Hi! How can I help you today?"></textarea>
                        <span class="form-hint">The greeting message when a user opens the chat.</span>
                    </div>

                    <!-- Theme -->
                    <div class="form-group">
                        <label class="form-label">Theme</label>
                        <select id="settingsTheme" class="form-select w-full">
                            <option value="minimal">Minimal (Oura Style)</option>
                            <option value="glassmorphism">Glassmorphism</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>

                    <!-- Language -->
                    <div class="form-group">
                        <label class="form-label">Language</label>
                        <select id="settingsLanguage" class="form-select w-full">
                            <option value="en">English</option>
                            <option value="de">German</option>
                            <option value="fr">French</option>
                            <option value="es">Spanish</option>
                        </select>
                    </div>

                    <!-- Database View (Transparency) -->
                    <div class="form-group">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="settingsDbView" class="form-checkbox">
                            <span class="form-label mb-0">Enable Database Transparency View</span>
                        </label>
                        <span class="form-hint">Allows users to see basic safe metadata about their data storage
                            (Privacy feature).</span>
                    </div>

                    <!-- Primary Color -->
                    <div class="form-group">
                        <label class="form-label">Primary Color</label>
                        <div class="flex items-center gap-3">
                            <input type="color" id="settingsPrimaryColor" value="#6366f1"
                                style="width: 48px; height: 36px; border: none; border-radius: var(--radius-md); cursor: pointer;">
                            <input type="text" id="settingsPrimaryColorText" class="form-input" value="#6366f1"
                                style="width: 100px; font-family: var(--font-mono);">
                        </div>
                    </div>

                    <!-- Position -->
                    <div class="form-group">
                        <label class="form-label">Widget Position</label>
                        <select id="settingsPosition" class="form-select w-full">
                            <option value="bottom-right">Bottom Right</option>
                            <option value="bottom-left">Bottom Left</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="Vallit.Modal.close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function copyEmbed(companyId) {
        const code = `<script src="{{ request.host_url }}widget/embed.js" data-company-id="${companyId}" data-theme="minimal"><\/script>`;
        Vallit.copyToClipboard(code);
    }

    // Sync color inputs
    document.getElementById('settingsPrimaryColor').addEventListener('input', function (e) {
        document.getElementById('settingsPrimaryColorText').value = e.target.value;
    });
    document.getElementById('settingsPrimaryColorText').addEventListener('input', function (e) {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
            document.getElementById('settingsPrimaryColor').value = e.target.value;
        }
    });

    // Open settings modal
    async function openSettings(companyId, companyName) {
        document.getElementById('settingsCompanyId').value = companyId;
        document.querySelector('#widget-settings-modal .modal-title').textContent = `Widget Settings - ${companyName}`;

        // Load current settings
        try {
            const res = await fetch(`/api/admin/companies/${companyId}/widget-settings`);
            const data = await res.json();
            const settings = data.settings || {};

            document.getElementById('settingsBotName').value = settings.bot_name || 'Kian';
            document.getElementById('settingsWelcomeMessage').value = settings.welcome_message || "Hi! I'm Kian, your AI Agent. How can I help you today?";
            document.getElementById('settingsTheme').value = settings.theme || 'minimal';
            document.getElementById('settingsLanguage').value = settings.language || 'en';
            document.getElementById('settingsDbView').checked = settings.show_db_view === true;
            document.getElementById('settingsPrimaryColor').value = settings.primary_color || '#6366f1';
            document.getElementById('settingsPrimaryColorText').value = settings.primary_color || '#6366f1';
            document.getElementById('settingsPosition').value = settings.position || 'bottom-right';
        } catch (e) {
            console.error('Failed to load settings:', e);
        }

        Vallit.Modal.open('widget-settings-modal');
    }

    // Save settings
    document.getElementById('widgetSettingsForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const companyId = document.getElementById('settingsCompanyId').value;
        const settings = {
            bot_name: document.getElementById('settingsBotName').value,
            welcome_message: document.getElementById('settingsWelcomeMessage').value,
            theme: document.getElementById('settingsTheme').value,
            language: document.getElementById('settingsLanguage').value,
            show_db_view: document.getElementById('settingsDbView').checked,
            primary_color: document.getElementById('settingsPrimaryColor').value,
            position: document.getElementById('settingsPosition').value
        };

        try {
            const res = await fetch(`/api/admin/companies/${companyId}/widget-settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ settings })
            });
            const data = await res.json();

            if (data.success) {
                Vallit.Modal.close();
                Vallit.Toast.success('Widget settings saved');
            } else {
                Vallit.Toast.error(data.error || 'Failed to save settings');
            }
        } catch (e) {
            Vallit.Toast.error('Failed to save settings');
        }
    });
</script>
{% endblock %}