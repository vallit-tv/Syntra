{% extends "layout_console.html" %}

{% block page_title %}Users{% endblock %}

{% block header_left %}
<div style="display:flex; align-items:center; gap:12px;">
    <h1 style="margin:0; font-size:14px; font-weight:600;">Users</h1>
    <button onclick="openInviteModal()" class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;">
        <i data-lucide="plus" width="12" height="12"></i>
        Invite
    </button>
</div>
{% endblock %}

{% block content %}
<div style="max-width: 1000px;">

    <div class="subtitle">
        Manage team members and their access levels.
    </div>

    <!-- Users List -->
    <div class="console-list">
        <div class="list-header"
            style="display:grid; grid-template-columns: 2fr 100px 1.5fr 100px 50px; gap:var(--space-md);">
            <span>User</span>
            <span>Role</span>
            <span>Company</span>
            <span>Status</span>
            <span></span>
        </div>

        {% if users %}
        {% for u in users %}
        <div class="list-item"
            style="display:grid; grid-template-columns: 2fr 100px 1.5fr 100px 50px; gap:var(--space-md);">
            <div style="font-weight:500; display:flex; align-items:center; gap:10px;">
                <div
                    style="width:24px; height:24px; background:var(--console-bg-active); color:var(--console-text-secondary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight: 600; border: 1px solid var(--console-border);">
                    {{ u.name[0]|upper }}
                </div>
                {{ u.name }}
            </div>
            <div>
                <span
                    style="font-size:11px; padding:2px 6px; border-radius:4px; border: 1px solid var(--console-border); background:var(--console-bg); color:var(--console-text-secondary); text-transform:uppercase; font-family: var(--font-mono);">
                    {{ u.get('role', 'user') }}
                </span>
            </div>
            <div style="color:var(--console-text-secondary); font-size: 13px;">
                {{ u.company_name if u.company_name else 'â€”' }}
            </div>
            <div style="display: flex; align-items: center;">
                <span class="status-dot {% if u.get('is_password_set') %}active{% endif %}"></span>
                <span style="font-size:12px; color:var(--console-text-secondary); margin-left:6px;">
                    {{ 'Active' if u.get('is_password_set') else 'Pending' }}
                </span>
            </div>
            <div style="text-align: right;">
                <a href="{{ url_for('admin_user_edit', user_id=u.id) }}" class="btn btn-secondary"
                    style="padding: 4px; border: none;" title="Edit User">
                    <i data-lucide="more-horizontal" width="16" height="16"></i>
                </a>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div style="padding:var(--space-xl); text-align:center; color:var(--console-text-secondary);">
            No users found.
        </div>
        {% endif %}
    </div>
</div>

<!-- Invite Modal (Hidden by default, simple overlay) -->
<div id="inviteModal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:999; align-items:center; justify-content:center;">
    <div
        style="background:var(--console-bg-panel); border:1px solid var(--console-border); padding:var(--space-lg); width:300px; border-radius:8px;">
        <h3 style="margin-top:0; font-size:14px; font-weight:600; margin-bottom:var(--space-md);">Invite User</h3>
        <form id="inviteForm" style="display:flex; flex-direction:column; gap:var(--space-md);">
            <input type="text" id="userName" placeholder="Username" required class="cmd-bar"
                style="width:100%; color:var(--console-text-primary);">
            <select id="userRole" class="cmd-bar" style="width:100%; color:var(--console-text-primary);">
                <option value="user">User</option>
                <option value="admin">Admin</option>
            </select>
            <div style="display:flex; gap:var(--space-sm); margin-top:var(--space-sm);">
                <button type="submit"
                    style="flex:1; background:var(--console-text-primary); color:var(--console-bg); border:none; padding:8px; border-radius:4px; cursor:pointer;">Invite</button>
                <button type="button" onclick="document.getElementById('inviteModal').style.display='none'"
                    style="flex:1; background:transparent; border:1px solid var(--console-border); color:var(--console-text-primary); padding:8px; border-radius:4px; cursor:pointer;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openInviteModal() {
        const el = document.getElementById('inviteModal');
        el.style.display = 'flex';
        document.getElementById('userName').focus();
    }

    document.getElementById('inviteForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const data = {
            name: document.getElementById('userName').value,
            role: document.getElementById('userRole').value
        };
        fetch('/api/admin/users', {
            method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'application/json' }
        }).then(r => r.json()).then(d => {
            if (d.error) alert(d.error); else location.reload();
        });
    });
</script>
{% endblock %}