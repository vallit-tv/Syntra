{% extends "admin/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('admin_dashboard') }}">Admin</a>
<span class="breadcrumbs-separator">/</span>
<span>Widgets</span>
{% endblock %}

{% block admin_content %}
<!-- Page Header with Inline Stats -->
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">Chat Widgets</h1>
        <div class="page-stats-inline">
            <span class="stat-item">
                <span class="stat-value">{{ companies|length }}</span> widgets
            </span>
            <span class="stat-divider">·</span>
            <span class="stat-item">
                <span class="stat-value">{{ companies|selectattr('has_activity')|list|length }}</span> active
            </span>
            <span class="stat-divider">·</span>
            <span class="stat-item">
                <span class="stat-value">{{ companies|sum(attribute='total_messages') }}</span> messages (30d)
            </span>
        </div>
    </div>
</div>

<!-- Widget Cards Grid -->
{% if companies %}
<div class="widget-grid">
    {% for company in companies %}
    <div class="widget-card">
        <div class="widget-card-header">
            <h3 class="widget-card-title">{{ company.company_name }}</h3>
            <span class="widget-card-status">
                <span class="status-dot {{ 'active' if company.has_activity else 'inactive' }}"></span>
                {{ 'Active' if company.has_activity else 'Inactive' }}
            </span>
        </div>
        <div class="widget-card-stats">
            {{ company.total_messages }} messages · {{ company.total_sessions }} sessions
        </div>
        <div class="widget-card-actions">
            <button class="btn btn-secondary btn-sm" onclick="copyEmbed('{{ company.company_id }}')">
                <i data-lucide="copy" width="12" height="12"></i>
                Copy Embed
            </button>
            <a href="{{ url_for('admin_widget_detail', company_id=company.company_id) }}" class="btn btn-primary btn-sm"
                style="flex: 1;">
                View →
            </a>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="dashboard-card">
    <div class="empty-state">
        <div class="empty-state-icon"><i data-lucide="bot" width="32" height="32"></i></div>
        <h3 class="empty-state-title">No widgets</h3>
        <p class="empty-state-description">Create a company first to manage widgets.</p>
        <a href="{{ url_for('admin_companies') }}" class="btn btn-primary btn-sm">Go to Companies</a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block admin_scripts %}
<script>
    function copyEmbed(companyId) {
        const code = `<script src="{{ request.host_url }}widget/embed.js" data-company-id="${companyId}" data-theme="minimal"><\/script>`;
        navigator.clipboard.writeText(code).then(() => {
            // Show toast or feedback
            alert('Embed code copied to clipboard!');
        });
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
</script>
{% endblock %}