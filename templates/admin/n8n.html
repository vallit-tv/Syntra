{% extends "admin/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('admin_dashboard') }}">Admin</a>
<span class="breadcrumbs-separator">/</span>
<span>n8n Editor</span>
{% endblock %}

{% block admin_content %}
<div class="page-header">
    <h1 class="page-title">n8n Workflow Editor</h1>
    <p class="page-description">Access your n8n instance to create and manage workflows.</p>
</div>

{% if n8n_overview %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Workflows Tracked</span>
            <div class="stat-icon blue">
                <i data-lucide="workflow" width="18" height="18"></i>
            </div>
        </div>
        <div class="stat-value">{{ n8n_overview.total_workflows }}</div>
        <p class="stat-caption">{{ n8n_overview.synced_workflows }} synced from n8n</p>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Out of Sync</span>
            <div class="stat-icon amber">
                <i data-lucide="upload-cloud" width="18" height="18"></i>
            </div>
        </div>
        <div class="stat-value">{{ n8n_overview.unsynced_workflows }}</div>
        <p class="stat-caption">
            {% if n8n_overview.last_synced_at %}
                Last sync {{ n8n_overview.last_synced_at|format_datetime('relative') }}
            {% else %}
                Awaiting first sync
            {% endif %}
        </p>
    </div>
</div>
{% endif %}

<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">n8n Connection Status</h2>
    </div>
    <div class="card-body">
        {% if n8n_configured %}
            {% if n8n_status and n8n_status.connected %}
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <span class="status-badge active">
                    <span class="status-badge-dot"></span>
                    Connected
                </span>
                <span style="color: var(--color-text-secondary);">{{ n8n_status.message }}</span>
            </div>
            
            <div class="detail-item">
                <strong>n8n URL:</strong> <a href="{{ n8n_url }}" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary);">{{ n8n_url }}</a>
            </div>
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <a href="{{ n8n_url }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="external-link" width="16" height="16"></i>
                    Open n8n Editor
                </a>
                <button id="syncNowBtn" onclick="syncNow()" class="btn btn-success" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="refresh-cw" width="16" height="16"></i>
                    Sync Now
                </button>
                <a href="{{ url_for('admin_workflows') }}" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="workflow" width="16" height="16"></i>
                    View Workflows
                </a>
            </div>
            
            <!-- Sync Status -->
            <div id="syncStatus" style="margin-top: 1.5rem; padding: 1rem; border-radius: var(--db-radius-md); background-color: var(--db-bg-secondary); display: none;">
                <div id="syncMessage" style="color: var(--db-text-primary);"></div>
            </div>
            {% else %}
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <span class="status-badge inactive">
                    <span class="status-badge-dot"></span>
                    Disconnected
                </span>
                <span style="color: var(--color-danger);">{{ n8n_status.message if n8n_status else 'Cannot connect to n8n' }}</span>
            </div>
            
            <div class="detail-item">
                <strong>n8n URL:</strong> <code>{{ n8n_url }}</code>
            </div>
            
            {% if 'your-ngrok-url' in (n8n_url or '') %}
            <div style="margin-top: 1.5rem; padding: 1rem; background-color: var(--db-bg-secondary); border-radius: var(--db-radius-md); border-left: 3px solid var(--db-warning);">
                <h3 style="margin: 0 0 0.5rem 0; color: var(--db-text-primary);">⚠️ Configuration Required</h3>
                <p style="margin: 0 0 0.75rem 0; color: var(--db-text-secondary);">
                    Your N8N_URL is still set to the placeholder value. Follow these steps:
                </p>
                
                {% if saved_ngrok_url %}
                <div style="margin: 1rem 0; padding: 0.75rem; background-color: var(--db-bg-primary); border: 1px solid var(--db-border); border-radius: var(--db-radius-sm);">
                    <p style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: var(--db-text-secondary);">
                        <strong>Found ngrok URL from start script:</strong>
                    </p>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <code id="ngrokUrlToCopy" style="flex: 1; padding: 0.5rem; background-color: var(--db-bg-light); border: 1px solid var(--db-border); border-radius: var(--db-radius-sm); font-size: 0.875rem; word-break: break-all;">{{ saved_ngrok_url }}</code>
                        <button onclick="copyNgrokUrl(event)" class="btn btn-secondary btn-sm" style="white-space: nowrap;">
                            <i data-lucide="copy" width="14" height="14"></i>
                            Copy
                        </button>
                    </div>
                    <p style="margin: 0; font-size: 0.8125rem; color: var(--db-text-secondary);">
                        Use this command to update your .env file:
                    </p>
                    <code style="display: block; margin-top: 0.5rem; padding: 0.5rem; background-color: var(--db-bg-light); border: 1px solid var(--db-border); border-radius: var(--db-radius-sm); font-size: 0.8125rem;">
                        sed -i '' 's|N8N_URL=.*|N8N_URL={{ saved_ngrok_url }}|' .env
                    </code>
                </div>
                {% endif %}
                
                <ol style="margin: 0; padding-left: 1.5rem; color: var(--db-text-secondary);">
                    {% if not saved_ngrok_url %}
                    <li style="margin-bottom: 0.5rem;">Run <code>./start-n8n-ngrok.sh</code> to start n8n and get your ngrok URL</li>
                    {% endif %}
                    <li style="margin-bottom: 0.5rem;">{% if saved_ngrok_url %}Copy the URL above or {% endif %}Update your <code>.env</code> file: set <code>N8N_URL</code> to the ngrok URL</li>
                    <li style="margin-bottom: 0.5rem;">Restart your Flask application</li>
                </ol>
            </div>
            {% else %}
            <p style="margin-top: 1rem; color: var(--color-text-secondary);">
                Please check that your n8n instance is running and accessible at the configured URL.
            </p>
            {% endif %}
            {% endif %}
        {% else %}
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <span class="status-badge inactive">
                <span class="status-badge-dot"></span>
                Not Configured
            </span>
        </div>
        
        <p style="color: var(--color-text-secondary);">
            n8n is not configured. Please set the following environment variables:
        </p>
        <ul style="margin-top: 1rem; color: var(--color-text-secondary);">
            <li><code>N8N_URL</code> - Your n8n instance URL</li>
            <li><code>N8N_API_KEY</code> - Your n8n API key</li>
        </ul>
        {% endif %}
    </div>
</div>

<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">About n8n Integration</h2>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 1rem;">
            Use the n8n editor to create and manage automation workflows. Once created, you can:
        </p>
        <ul style="margin-left: 1.5rem; color: var(--color-text-secondary);">
            <li>Sync workflows to Syntra using the "Sync with n8n" button in <a href="{{ url_for('admin_workflows') }}" style="color: var(--color-primary);">Admin Workflows</a></li>
            <li>Mark workflows as public to make them available to companies</li>
            <li>Monitor workflow executions and manage company activations</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
function copyNgrokUrl(event) {
    const urlElement = document.getElementById('ngrokUrlToCopy');
    if (!urlElement) return;
    
    const url = urlElement.textContent.trim();
    navigator.clipboard.writeText(url).then(() => {
        // Show feedback
        const btn = event ? event.target.closest('button') : document.querySelector('button[onclick*="copyNgrokUrl"]');
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="check" width="14" height="14"></i> Copied!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-secondary');
            lucide.createIcons();
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                lucide.createIcons();
            }, 2000);
        }
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}

async function syncNow() {
    const btn = document.getElementById('syncNowBtn');
    const statusDiv = document.getElementById('syncStatus');
    const messageDiv = document.getElementById('syncMessage');
    
    // Set button to loading state
    const resetBtn = syntra.setButtonLoading(btn, '<i data-lucide="loader-2" width="16" height="16" class="animate-spin"></i> Syncing...');
    
    // Show status div
    statusDiv.style.display = 'block';
    messageDiv.innerHTML = '<i data-lucide="loader-2" width="16" height="16" class="animate-spin"></i> Syncing workflows from n8n...';
    lucide.createIcons();
    
    try {
        const response = await fetch('/api/admin/workflows/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--db-success);">
                    <i data-lucide="check-circle" width="16" height="16"></i>
                    <strong>Sync completed successfully!</strong>
                </div>
                <div style="margin-top: 0.5rem; font-size: 13px; color: var(--db-text-secondary);">
                    ${result.added} added, ${result.updated} updated, ${result.removed} removed (${result.total} total)
                </div>
            `;
            
            // Reload page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--db-danger);">
                    <i data-lucide="alert-circle" width="16" height="16"></i>
                    <strong>Sync failed</strong>
                </div>
                <div style="margin-top: 0.5rem; font-size: 13px; color: var(--db-text-secondary);">
                    ${result.error || 'Unknown error occurred'}
                </div>
            `;
            resetBtn();
        }
        
        lucide.createIcons();
    } catch (error) {
        messageDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--db-danger);">
                <i data-lucide="alert-circle" width="16" height="16"></i>
                <strong>Error: ${error.message}</strong>
            </div>
        `;
        lucide.createIcons();
        resetBtn();
    }
}

lucide.createIcons();
</script>
{% endblock %}

