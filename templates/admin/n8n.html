{% extends "admin/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('admin_dashboard') }}">Admin</a>
<span class="breadcrumbs-separator">/</span>
<span>n8n Editor</span>
{% endblock %}

{% block admin_content %}
<div class="page-header">
    <h1 class="page-title">n8n Workflow Editor</h1>
    <p class="page-description">Access your n8n instance to create and manage workflows.</p>
</div>

{% if error_message %}
<div class="dashboard-card" style="margin-bottom: 1.5rem; border-left: 3px solid var(--db-danger);">
    <div class="card-body">
        <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--db-danger);">
            <i data-lucide="alert-circle" width="20" height="20"></i>
            <strong>Error loading n8n page</strong>
        </div>
        <p style="margin-top: 0.5rem; color: var(--db-text-secondary);">{{ error_message }}</p>
    </div>
</div>
{% endif %}

{% if n8n_overview %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Workflows Tracked</span>
            <div class="stat-icon blue">
                <i data-lucide="workflow" width="18" height="18"></i>
            </div>
        </div>
        <div class="stat-value">{{ n8n_overview.total_workflows }}</div>
        <p class="stat-caption">{{ n8n_overview.synced_workflows }} synced from n8n</p>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Out of Sync</span>
            <div class="stat-icon amber">
                <i data-lucide="upload-cloud" width="18" height="18"></i>
            </div>
        </div>
        <div class="stat-value">{{ n8n_overview.unsynced_workflows }}</div>
        <p class="stat-caption">
            {% if n8n_overview.last_synced_at %}
                Last sync {{ n8n_overview.last_synced_at|format_datetime('relative') }}
            {% else %}
                Awaiting first sync
            {% endif %}
        </p>
    </div>
</div>
{% else %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Workflows Tracked</span>
            <div class="stat-icon blue">
                <i data-lucide="workflow" width="18" height="18"></i>
            </div>
        </div>
        <div class="stat-value">0</div>
        <p class="stat-caption">No workflows tracked yet</p>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Out of Sync</span>
            <div class="stat-icon amber">
                <i data-lucide="upload-cloud" width="18" height="18"></i>
            </div>
        </div>
        <div class="stat-value">0</div>
        <p class="stat-caption">Awaiting first sync</p>
    </div>
</div>
{% endif %}

<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">n8n Connection Status</h2>
    </div>
    <div class="card-body">
        {% if n8n_configured %}
            {% if n8n_status and n8n_status.connected %}
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <span class="status-badge active">
                    <span class="status-badge-dot"></span>
                    Connected
                </span>
                <span style="color: var(--color-text-secondary);">{{ n8n_status.message }}</span>
            </div>
            
            <div class="detail-item">
                <strong>n8n URL:</strong> <a href="{{ n8n_url }}" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary);">{{ n8n_url }}</a>
            </div>
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <a href="{{ n8n_url }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="external-link" width="16" height="16"></i>
                    Open n8n Editor
                </a>
                <button id="syncNowBtn" onclick="syncNow()" class="btn btn-success" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="refresh-cw" width="16" height="16"></i>
                    Sync Now
                </button>
                <a href="{{ url_for('admin_workflows') }}" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="workflow" width="16" height="16"></i>
                    View Workflows
                </a>
            </div>
            
            <!-- Sync Status -->
            <div id="syncStatus" style="margin-top: 1.5rem; padding: 1rem; border-radius: var(--db-radius-md); background-color: var(--db-bg-secondary); display: none;">
                <div id="syncMessage" style="color: var(--db-text-primary);"></div>
            </div>
            {% else %}
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <span class="status-badge inactive">
                    <span class="status-badge-dot"></span>
                    Disconnected
                </span>
                <span style="color: var(--color-danger);">
                    {% if n8n_status and n8n_status.message %}
                        {{ n8n_status.message.split('\n')[0] }}
                    {% else %}
                        Cannot connect to n8n
                    {% endif %}
                </span>
            </div>
            
            <div class="detail-item">
                <strong>n8n URL:</strong> 
                {% if n8n_url %}
                    <a href="{{ n8n_url }}" target="_blank" rel="noopener noreferrer" style="color: var(--color-primary); text-decoration: underline;">{{ n8n_url }}</a>
                {% else %}
                    <code>Not configured</code>
                {% endif %}
            </div>
            
            {% else %}
            <p style="margin-top: 1rem; color: var(--color-text-secondary);">
                Please check that your n8n instance is running and accessible at the configured URL.
            </p>
            {% endif %}
            {% endif %}
        {% else %}
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
            <span class="status-badge inactive">
                <span class="status-badge-dot"></span>
                Not Configured
            </span>
        </div>
        
        <p style="color: var(--color-text-secondary);">
            n8n is not configured. Please set the following environment variable:
        </p>
        <ul style="margin-top: 1rem; color: var(--color-text-secondary);">
            <li><code>N8N_API_KEY</code> - Your n8n Cloud API key (required)</li>
            <li><code>N8N_URL</code> - Your n8n workspace URL (optional, defaults to https://app.n8n.cloud)</li>
        </ul>
        <p style="margin-top: 1rem; padding: 1rem; background-color: var(--db-bg-secondary); border-radius: var(--db-radius-md); border-left: 3px solid var(--db-info);">
            <strong>Getting your API key:</strong><br>
            Log in to your n8n Cloud account, go to Settings â†’ n8n API, and create a new API key.
        </p>
        {% endif %}
    </div>
</div>

<div class="dashboard-card">
    <div class="card-header">
        <h2 class="card-title">About n8n Integration</h2>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 1rem;">
            Use the n8n editor to create and manage automation workflows. Once created, you can:
        </p>
        <ul style="margin-left: 1.5rem; color: var(--color-text-secondary);">
            <li>Sync workflows to Syntra using the "Sync with n8n" button in <a href="{{ url_for('admin_workflows') }}" style="color: var(--color-primary);">Admin Workflows</a></li>
            <li>Mark workflows as public to make them available to companies</li>
            <li>Monitor workflow executions and manage company activations</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block dashboard_scripts %}
<script>
function copyNgrokUrl(event) {
    const urlElement = document.getElementById('ngrokUrlToCopy');
    if (!urlElement) return;
    
    const url = urlElement.textContent.trim();
    navigator.clipboard.writeText(url).then(() => {
        // Show feedback
        const btn = event ? event.target.closest('button') : document.querySelector('button[onclick*="copyNgrokUrl"]');
        if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="check" width="14" height="14"></i> Copied!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-secondary');
            lucide.createIcons();
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                lucide.createIcons();
            }, 2000);
        }
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}

async function syncNow() {
    const btn = document.getElementById('syncNowBtn');
    const statusDiv = document.getElementById('syncStatus');
    const messageDiv = document.getElementById('syncMessage');
    
    // Set button to loading state
    const resetBtn = syntra.setButtonLoading(btn, '<i data-lucide="loader-2" width="16" height="16" class="animate-spin"></i> Syncing...');
    
    // Show status div
    statusDiv.style.display = 'block';
    messageDiv.innerHTML = '<i data-lucide="loader-2" width="16" height="16" class="animate-spin"></i> Syncing workflows from n8n...';
    lucide.createIcons();
    
    try {
        const response = await fetch('/api/admin/workflows/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--db-success);">
                    <i data-lucide="check-circle" width="16" height="16"></i>
                    <strong>Sync completed successfully!</strong>
                </div>
                <div style="margin-top: 0.5rem; font-size: 13px; color: var(--db-text-secondary);">
                    ${result.added} added, ${result.updated} updated, ${result.removed} removed (${result.total} total)
                </div>
            `;
            
            // Reload page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--db-danger);">
                    <i data-lucide="alert-circle" width="16" height="16"></i>
                    <strong>Sync failed</strong>
                </div>
                <div style="margin-top: 0.5rem; font-size: 13px; color: var(--db-text-secondary);">
                    ${result.error || 'Unknown error occurred'}
                </div>
            `;
            resetBtn();
        }
        
        lucide.createIcons();
    } catch (error) {
        messageDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--db-danger);">
                <i data-lucide="alert-circle" width="16" height="16"></i>
                <strong>Error: ${error.message}</strong>
            </div>
        `;
        lucide.createIcons();
        resetBtn();
    }
}

lucide.createIcons();
</script>
{% endblock %}

