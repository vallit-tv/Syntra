{% extends "admin/base.html" %}

{% block breadcrumbs %}
<a href="{{ url_for('admin_dashboard') }}">Admin</a>
<span class="breadcrumbs-separator">/</span>
<span>n8n Integration</span>
{% endblock %}

{% block admin_content %}
<!-- Page Header -->
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">n8n Integration</h1>
        <p class="page-description">Connect your n8n instance to sync workflows</p>
    </div>
</div>

<!-- Two Column Settings Layout -->
<div class="settings-grid">
    <!-- Left Column: Connection -->
    <div class="settings-section">
        <h3 class="settings-section-title">Connection</h3>

        {% if n8n_configured %}
        {% if n8n_status and n8n_status.connected %}
        <div class="settings-row">
            <span class="settings-label">Status</span>
            <span class="status-indicator">
                <span class="status-dot connected"></span>
                Connected
            </span>
        </div>
        <div class="settings-row">
            <span class="settings-label">n8n URL</span>
            <a href="{{ n8n_url }}" target="_blank" rel="noopener" class="settings-value"
                style="color: var(--db-text-primary); text-decoration: underline;">
                {{ n8n_url|truncate(30) }}
            </a>
        </div>
        <div class="settings-row">
            <span class="settings-label">Workflows</span>
            <span class="settings-value">{{ n8n_overview.total_workflows if n8n_overview else 0 }} tracked</span>
        </div>
        <div class="settings-row">
            <span class="settings-label">Last sync</span>
            <span class="settings-value" style="color: var(--db-text-secondary);">
                {% if n8n_overview and n8n_overview.last_synced_at %}
                {{ n8n_overview.last_synced_at|format_datetime('relative') }}
                {% else %}
                Awaiting first sync
                {% endif %}
            </span>
        </div>

        <div style="margin-top: var(--db-space-lg); display: flex; flex-direction: column; gap: var(--db-space-sm);">
            <a href="{{ n8n_url }}" target="_blank" rel="noopener" class="btn btn-primary btn-sm">
                <i data-lucide="external-link" width="14" height="14"></i>
                Open n8n Editor
            </a>
            <button id="syncNowBtn" onclick="syncNow()" class="btn btn-secondary btn-sm">
                <i data-lucide="refresh-cw" width="14" height="14"></i>
                Sync Workflows
            </button>
            <a href="{{ url_for('admin_workflows') }}" class="btn btn-secondary btn-sm">
                <i data-lucide="workflow" width="14" height="14"></i>
                View Workflows
            </a>
        </div>

        <!-- Sync Status -->
        <div id="syncStatus"
            style="margin-top: var(--db-space-md); padding: var(--db-space-md); border-radius: var(--db-radius-md); background-color: var(--db-bg-secondary); display: none;">
            <div id="syncMessage" style="font-size: var(--db-text-sm); color: var(--db-text-primary);"></div>
        </div>
        {% else %}
        <div class="settings-row">
            <span class="settings-label">Status</span>
            <span class="status-indicator">
                <span class="status-dot disconnected"></span>
                Disconnected
            </span>
        </div>
        <div class="settings-row">
            <span class="settings-label">n8n URL</span>
            <span class="settings-value" style="color: var(--db-text-tertiary);">
                {% if n8n_url %}{{ n8n_url|truncate(30) }}{% else %}Not configured{% endif %}
            </span>
        </div>
        <p style="margin-top: var(--db-space-md); font-size: var(--db-text-sm); color: var(--db-text-tertiary);">
            {% if n8n_status and n8n_status.message %}
            {{ n8n_status.message.split('\n')[0] }}
            {% else %}
            Cannot connect to n8n instance.
            {% endif %}
        </p>
        {% endif %}
        {% else %}
        <div class="settings-row">
            <span class="settings-label">Status</span>
            <span class="status-indicator">
                <span class="status-dot disconnected"></span>
                Not Configured
            </span>
        </div>
        <p style="margin-top: var(--db-space-md); font-size: var(--db-text-sm); color: var(--db-text-secondary);">
            Set the following environment variables:
        </p>
        <ul
            style="margin-top: var(--db-space-sm); font-size: var(--db-text-sm); color: var(--db-text-tertiary); padding-left: var(--db-space-lg);">
            <li><code class="code-inline">N8N_API_KEY</code> — Required</li>
            <li><code class="code-inline">N8N_URL</code> — Optional</li>
        </ul>
        {% endif %}
    </div>

    <!-- Right Column: About -->
    <div class="settings-section">
        <h3 class="settings-section-title">About</h3>
        <p
            style="font-size: var(--db-text-sm); color: var(--db-text-secondary); line-height: 1.6; margin-bottom: var(--db-space-md);">
            n8n is a workflow automation tool that connects apps and automates tasks.
        </p>
        <p
            style="font-size: var(--db-text-sm); color: var(--db-text-secondary); line-height: 1.6; margin-bottom: var(--db-space-md);">
            Once connected, you can:
        </p>
        <ul
            style="font-size: var(--db-text-sm); color: var(--db-text-secondary); padding-left: var(--db-space-lg); line-height: 1.8;">
            <li>Sync workflows from n8n</li>
            <li>Mark workflows as public for companies</li>
            <li>Monitor workflow executions</li>
        </ul>
        <div style="margin-top: var(--db-space-lg);">
            <a href="https://docs.n8n.io/" target="_blank" rel="noopener"
                style="font-size: var(--db-text-sm); color: var(--db-text-secondary); text-decoration: underline;">
                Learn more about n8n →
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_scripts %}
<script>
    async function syncNow() {
        const btn = document.getElementById('syncNowBtn');
        const statusDiv = document.getElementById('syncStatus');
        const messageDiv = document.getElementById('syncMessage');

        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="refresh-cw" width="14" height="14" class="spin"></i> Syncing...';
        if (typeof lucide !== 'undefined') lucide.createIcons();

        statusDiv.style.display = 'block';
        messageDiv.innerHTML = 'Syncing workflows from n8n...';

        try {
            const response = await fetch('/api/admin/workflows/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();

            if (response.ok && result.success) {
                messageDiv.innerHTML = `✓ Sync completed: ${result.added} added, ${result.updated} updated`;
                setTimeout(() => window.location.reload(), 1500);
            } else {
                messageDiv.innerHTML = `✗ ${result.error || 'Sync failed'}`;
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="refresh-cw" width="14" height="14"></i> Sync Workflows';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        } catch (error) {
            messageDiv.innerHTML = `✗ Error: ${error.message}`;
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="refresh-cw" width="14" height="14"></i> Sync Workflows';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    }

    if (typeof lucide !== 'undefined') lucide.createIcons();
</script>
<style>
    .code-inline {
        font-size: var(--db-text-xs);
        background: var(--db-bg-tertiary);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: var(--db-font-mono);
    }

    .spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}