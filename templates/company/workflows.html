{% extends "company/base.html" %}

{% block breadcrumbs %}
<span>Workflows</span>
{% endblock %}

{% block company_content %}
<div class="page-header">
    <h1 class="page-title">Workflows</h1>
    <p class="page-description">Activate and manage automation workflows for your company.</p>
</div>

<div class="filters-bar">
    <div style="position: relative; flex: 1; min-width: 240px;">
        <i data-lucide="search" width="16" height="16" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--color-text-lighter);"></i>
        <input type="text" id="searchInput" class="search-input" placeholder="Search workflows..." style="padding-left: 2.5rem;">
    </div>
    <select id="statusFilter" class="filter-select">
        <option value="">All Status</option>
        <option value="activated">Activated</option>
        <option value="not-activated">Not Activated</option>
    </select>
</div>

<div class="dashboard-card">
    {% if workflows %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Required Services</th>
                    <th>Last Run</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="workflowTableBody">
                {% for workflow in workflows %}
                {% set row_status = 'activated' if workflow.is_activated else 'not-activated' %}
                <tr data-status="{{ row_status }}" data-name="{{ workflow.name|lower }}" data-description="{{ workflow.description|default('')|lower }}">
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            {% if workflow.is_activated %}
                            <a href="{{ url_for('company_workflow_detail', workflow_id=workflow.id) }}" class="table-link">
                                {{ workflow.name }}
                            </a>
                            {% else %}
                            <span style="font-weight: 600;">{{ workflow.name }}</span>
                            {% endif %}
                            <span class="text-secondary">{{ workflow.description|default('No description provided') }}</span>
                        </div>
                    </td>
                    <td>
                        {% if workflow.is_activated %}
                            {% if workflow.is_ready %}
                            <span class="status-badge active">
                                <span class="status-badge-dot"></span>
                                Ready
                            </span>
                            {% elif workflow.activation.missing_services %}
                            <span class="status-badge warning">
                                <span class="status-badge-dot"></span>
                                Needs Setup
                            </span>
                            <p class="text-secondary" style="margin-top: 0.25rem;">
                                Missing: {{ workflow.activation.missing_services|join(', ') }}
                            </p>
                            {% else %}
                            <span class="status-badge active">
                                <span class="status-badge-dot"></span>
                                Activated
                            </span>
                            {% endif %}
                        {% else %}
                        <span class="status-badge inactive">Not Activated</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if workflow.required_services_list %}
                            <div class="pill-row">
                                {% for service in workflow.required_services_list[:3] %}
                                <span class="pill small">{{ service }}</span>
                                {% endfor %}
                                {% if workflow.required_services_list|length > 3 %}
                                <span class="pill small muted">+{{ workflow.required_services_list|length - 3 }}</span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="text-secondary">None</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if workflow.activation and workflow.activation.last_executed_at %}
                            {{ workflow.activation.last_executed_at|format_datetime('relative') }}
                        {% else %}
                            <span class="text-secondary">No runs yet</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="table-actions">
                            {% if workflow.is_activated %}
                            <a href="{{ url_for('company_workflow_detail', workflow_id=workflow.id) }}" class="btn btn-secondary btn-sm">
                                <i data-lucide="settings" width="14" height="14"></i>
                                Configure
                            </a>
                            <button onclick="deactivateWorkflow(event, '{{ workflow.id }}')" class="btn btn-danger btn-sm">
                                Deactivate
                            </button>
                            {% else %}
                            <button onclick="activateWorkflow(event, '{{ workflow.id }}')" class="btn btn-primary btn-sm">
                                <i data-lucide="power" width="14" height="14"></i>
                                Activate
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i data-lucide="workflow" width="32" height="32"></i>
        </div>
        <h3 class="empty-state-title">No workflows available</h3>
        <p class="empty-state-description">No workflows are currently available. Contact your administrator.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block company_scripts %}
<script>
function activateWorkflow(event, workflowId) {
    const button = event.currentTarget;
    if (!window.confirm('Activate this workflow for your company?')) {
        return;
    }
    button.disabled = true;
    const original = button.innerHTML;
    button.innerHTML = '<span>Activating...</span>';
    fetch(`/api/company/workflows/${workflowId}/activate`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                window.alert('Activation failed: ' + data.error);
                button.disabled = false;
                button.innerHTML = original;
            } else {
                window.location.href = `/company/workflows/${workflowId}`;
            }
        })
        .catch(err => {
            window.alert('Activation error: ' + err);
            button.disabled = false;
            button.innerHTML = original;
        });
}

function deactivateWorkflow(event, workflowId) {
    const button = event.currentTarget;
    if (!window.confirm('Deactivate this workflow for your company?')) {
        return;
    }
    button.disabled = true;
    const original = button.textContent;
    button.textContent = 'Deactivating...';
    fetch(`/api/company/workflows/${workflowId}/deactivate`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                window.alert('Deactivation failed: ' + data.error);
                button.disabled = false;
                button.textContent = original;
            } else {
                window.location.reload();
            }
        })
        .catch(err => {
            window.alert('Deactivation error: ' + err);
            button.disabled = false;
            button.textContent = original;
        });
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const rows = Array.from(document.querySelectorAll('#workflowTableBody tr'));

    function filterWorkflows() {
        const searchText = searchInput.value.toLowerCase();
        const selectedStatus = statusFilter.value;

        rows.forEach(row => {
            const matchesSearch = row.dataset.name.includes(searchText) || row.dataset.description.includes(searchText);
            const matchesStatus = !selectedStatus || row.dataset.status === selectedStatus;
            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }

    searchInput.addEventListener('keyup', filterWorkflows);
    statusFilter.addEventListener('change', filterWorkflows);

    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}

